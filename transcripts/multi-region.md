# The AWS Multi-Region Starter Guide - Transcript

DAWN: Hello!  Once again it is good to be here, for what will hopefully be the final edition virtually of the Melbourne AWS user group for the foreseeable future!  And today, as Rob said, we are going on another detour into the world of ProductCorp, with their AWS multi-region starter guide.

First of all, I would like to acknowledge the Wurundjeri people of the Kulin Nation, on whose land I am presenting from tonight.  This is, and always will be, Aboriginal land.  Their sovereignty was never ceded.

Rob has done the introduction justice, as per usual.  But, for avoidance of doubt, my name is Dawn.  Ah, at present I am doing cloud security and DevOps at Innablr, and yes, we are hiring, as probably everyone else is these days.  And I'm really really eager to be able to holiday overseas again, because the borders have been shut for nearly two years at this point, and they're just starting to open - and I have to go and renew an Australian passport at some point!  Outside of work, I am an occasional author and kitchen alchemist - sometimes that ends really well, sometimes it doesn't.  I am also a raging sportsball fan, which is why that picture of me is me in a Boston Bruins sweater.

So when I came here last month to talk about Control Tower slightly more than 12 months on from my previous presentation, we had a discussion about ProductCorp's new mergers and acquisitions unit.  And - their first target in terms of mergers and acquisitions was a payments processing company called Fly Money.  ProductCorp essentially - they're a startup, they have a head office in Sydney, but essentially the bread and butter of what they do is e-commerce software.  They have two flagship products; one called SellIt which is a managed online shopping platform, and one called BuyIt which is effectively software as a service for inventory management sorts of things that retailers might need.  They've been around for about seven years and they run on AWS, but the reality of running ecommerce software is that you have to have a payments processor in there somewhere.  And so ProductCorp, in their infinite wisdom, decided that they were going to- cut out the middleman, and they were going to go out and buy themselves Fly Money, this small payments processing company.

And as you might remember from last month's talk, that hasn't gone well for them so far.  Because Fly Money is tiny; they're based in Melbourne, erm, but they operate worldwide.  So obviously they operate in Australia, New Zealand, that's where they came up.  But the really interesting thing is that there are certain parts of the world where the vast majority of payment processing, and indeed the vast majority of- technical interactions in general, are done solely via mobile phone.  Regions that have effectively bypassed the desktop.  So we're looking here at places like East and Southeast Africa.  And that is everywhere from Kenya to Namibia.  That's a huge swath of the continent is a really big market for Fly Money.  Likewise a lot of South America, very heavy on mobile phone usage, and some areas of Eastern Europe.  And this is where Fly Money have really found their market.

Now, from last month, we know that Fly Money's AWS set up is a bit of a disaster.  It consists of three AWS accounts, there we are no real clear boundaries about what goes where, and these three AWS accounts are running workloads in seven different regions.  So obviously they've got the `ap-southeast-2`, they run in Sydney, so that's where they've got all of their SSO, that's where they've got all of their initial infrastructure.  However, because a lot of the Eastern European countries that they serve are in the EU, they are actually running in two different EU regions; they're running in Éire, and they're running in Paris.  Thinking there effectively being a degree of regional replication and they can route different customers through different places.  They also run, eahh, instances in Hong Kong.  Now the reason for that is if you're doing anything related to payments processing, Hong Kong is actually a really large financial market.  For a similar reason, they do also run workloads in Northern Virginia, because it's the most stable of the US regions, it's also closest to DC.  And so that is covering off for them effectively a lot of the Asian market banking-wise, also covering off a lot of the US market banking-wise.

And in terms of regions that were released recently, as Fly Money have sort of noticed that a lot of their customers are around - East-Southeast Africa and South America, they have actually made use of a couple of AWS regions that have not been around for all that long.  And that- those are, the AWS region in São Paulo `sa-east-1`, and `af-south-1` in Cape Town.  Idea there obviously being; you want your workloads to be really close to your customers, reduce latency, and also potentially gets you out of hot water in terms of data protection issues.

Unfortunately for, ah, our poor long-suffering friend Ben Nguyen, Fly Money's regional setup is as much of a disaster as their AWS account setup was.  Now Ben is ProductCorp's Head of Engineering, and they're very passionate about improving infrastructure in general.  Which is probably a good thing, because the task that they're taking on at this point is starting to look quite titanic.  They have over 10 years of experience, but, also fortunately for- everyone at ProductCorp, they've mainly worked for startups, so it's not like it's the first time that they've ever seen something like this done really poorly and in a very slapdash way.

The first question that one kind of has to ask oneself when looking at the matter of- running things in multiple AWS regions is, what does region actually mean?  And the really [slowly] interesting sort of aspect to this is that - region, the meaning of the word region, is not the same across all of the different cloud providers.  And actually if you were in pretty well everyone other than AWS, but certainly Azure, and to a degree as well GCP, region does not mean a separation of concerns.  In the other cloud providers, it's really easy to go in and aggregate resources across regions to actually understand how all of your workloads are running, and then to drill deep down and actually break things down into individual regions so that you can compare things.  It's also very easy to make sure that you've got consistency across regions if that's something that you want to do.

However, in AWS, the regions are designed to be totally isolated from one another.  If you're in Azure, and- I believe if you're in GCP as well, although I've not played around with it as much, there is no dropdown like the one that you get in the AWS console that indicates that you have to actually choose a region.  The CLI is configured very differently.  You'll, in certain situations, be deploying things to particular regions, but it is possible to go in and actually aggregate everything across regions.  But AWS doesn't have that same capability built in.  The assumption in AWS is that regions are, as much as possible, entirely isolated from one another.  It's not just accounts that have a separation of concerns; regions do too.

Now Ben has touched Azure in the past, ah, has dabbled in GCP, and what they end up coming up with investigating the tangled mess that is Fly Money's services is a wishlist of things that they want and things that they want to be able to do.  And that starts with a few really obvious things; like consistency across regions.  They want to make sure that everything that is being deployed is, as much as possible, and as much as required, the same.  They want a discovery strategy.  So, some way to actually make sure that what should be running in particular regions is running in particular regions, to be able to check workloads across different regions, and also to be able to see whether there's anything that's running in particular regions that shouldn't be.  And as part of that, they actually want a unified cross-region search that will allow them to drill down and be able to look at particular resources across the AWS regions.  They want a reasonable cost for dev environments.  And so, effectively, this is a matter of obviously, ProductCorp - well, not obviously, but ProductCorp has only ever run anything in Sydney.  So what happens now that Fly Money has been brought in, and potentially you have to run seven different regions worth of dev environments - Ben wants a solution for that but it is not going to involve massive cost blowouts.

And on the, sort of, cross-region side, as opposed to the multi-region side, there are a few other things on Ben's wishlist.  One is the ability to prevent deployments in regions that aren't being used.  Now, a fairly standard AWS recommendation that you'll see trotted out often within companies is to actually separate out your regions into different accounts.  So if you had workloads running in Sydney, and workloads running in Singapore, you would have a different account for the Sydney resources compared to the Singapore resources.  That makes the setup somewhat more difficult, if you do choose to go down that route, but even if you don't - this being something that ProductCorp are currently on the fence on, despite it being a recommendation - even if you don't, you do actually want a way to turn off all of the regions that you're not using.  And there's, I believe, still 21 AWS regions.  So, even though Fly Money operates in seven of those 21, that's still a lot of places that you don't want stuff being deployed.  Ben wants some way to keep track of security issues, because going through into every region and actually checking what's going on manually security-wise is going to be a real pain.  And additionally, from that, some sort of way to hook up the alerting systems and the pagers so that they're actually getting information across region without you having to change things in seven different places.

So I kind of hinted at this before, but this effectively breaks down into two different concepts.  And the first one that we're going to look at is multi-region architecture.  This is how you actually set up your systems to be able to run them reliably, scalably, and consistently across multiple different AWS regions.  And the first important concept to understand here is workload consistency.  This does not mean that your workload in every single region is going to be exactly the same.  You may have some regions where you have way more users than others and you may need to scale accordingly.  However, it does mean that there are a series of questions that you want to be asking yourself about how consistent your workloads should be, and how you want this to look.

And that starts with the obvious question of - how close to identical are your regional setups?  And that's not just about size.  That can also be about the fact that if you're operating in, say, the EU, there might be additional software, or additional changes that you need to deploy into your systems, to actually reflect the regulatory and compliance framework in different areas.  You might also have certain aspects of your system that you only want to deploy for particular users in particular regions, if you have, say, a tiered pricing model, and most of your high tier customers are in one particular area.  And so the question around that then becomes - can you build a baseline that is as close to identical as possible everywhere, and then go in and actually bolt on anything that's region-specific?  And this doesn't just apply to AWS; any cloud provider where you're doing cross-region this- or multi-region deployment, this applies to.

And from there, do you want to deploy every region at once?  There could be really good reasons why you do want to do this, in the sense that it has you- it has you doing everything in one go, but there could also be really good reasons why you don't.  If you want to test something at a particular scale, you may only want to deploy it to your smallest region with the fewest customers, so that then you've got one or two clients that get really annoyed with you if it falls over, as compared to one or two hundred, or one or two thousand.  You may also have a situation where you only want to deploy particular changes to particular regions, as with the regulatory and compliance frameworks.  And then there's a question around how you actually move data.  Because in some cases you'll have a set up where- each of your regional workloads is entirely isolated, but that's not always going to be the case.  And so there's a question around, do you need communication across regions?  And if so, how are you going to achieve that?  With some services it's really intuitive, with others that can be very complex.

So there are a few different ways that we can look at the workload consistency piece, and - that really starts with as much as possible, having a modular structure.  So you're looking to be able to script things.  You're looking to be able to repeat things.  You're looking to be able to define infrastructure as code; so using something like CloudFormation or Terraform to actually produce code that you can take and deploy everywhere.  You can do it with Terraform modules, you can do it with CloudFormation stacks and stack sets; there's a lot of ability built into the AWS platform and built into a lot of these providers around reusability and repeatability of what you're deploying.

And another aspect of this that's really important is, of course, the CI/CD piece.  Without pipelines, you end up having to write manual runbooks for deployment.  And that may be fine when you're only deploying to one region, but when you have to deploy the same thing seven times to get it into production, you're greatly- increasing the risk of- one small error by the user throwing everything off, crashing environments, causing requirements around rollbacks, whereas the CI/CD pipelines you can basically just push it all through automatically.  And that's also give- going to give you a greater level of assurance that everything is the same in each place.  And if you do decide to split everything- split all your regions up into separate accounts, it's worth noting the existence of an AWS tool called Resource Access Manager, which actually allows you to take some of those resources and push them out across all of your accounts.  Not going to solve all of the region-based problems; we'll talk about some of those next.

Because, in short; you can afford bad architecture sometimes when you're running on a region-based scale, but- if you do end up having to deploy multi-region, that bad architecture is going to cost you exponentially more than it would if you were doing everything- only in the one place.  And so there are a lot of patterns here that do become really important.  We talked about modularity.  You want to be able to have everything defined in one place - so CloudFormation stack sets, Terraform modules - as much as possible you want all of that to be reusable.  You run into issues often where you have, say, we need to make small changes to a particular piece of infrastructure as code, and you end up actually changing that in seven or eight different places, rather than just having one module that you're pulling from and separate variables, or one module you're pulling from and writing region-specific configuration on top.  So that's a really big issue, but there are a few others.

When you're running in multiple different regions, zero-downtime deployment becomes exceptionally important.  There's a massive human cost, that is often not quantified, around contacting people to let them know when new releases are going out, scheduling those new releases, and particularly if you're running in distributed- areas that are distributed across the globe - and don't get me started on the timezone question here - it can be really intensive to have people actually go out and schedule all of those deployments out of hours if they require downtime.  And that can get you into a situation where- that effectively becomes the manager's job, or it requires a lot of coordination across different teams, and- that comes at the expense of system reliability and feature development.  So- investing that initial time in zero-downtime deployment - which Fly Money doesn't actually have at this point - is going to be a really important piece.  If you do need to transfer data across regions, it pays to think about how you're going to do that as well.  And that can be very simple, building on AWS tools, if you're doing things like VPC peering, but there are other situations where it may be a little bit more complex and it may require you to actually write some code.

Another thing that's very important when you're running in different regions is security baselines.  Because, if someone can get into your database in Region A, and then they can use that same attack vector or use the same set of credentials that they've reached to get into your database in the six other regions that you're running in, suddenly you have a really big problem.  And so part of that is about making sure that you do actually meet security standards, so patching your instances, dealing with really simple low-level things like preventing SQL injection, but part of it is also around properly handling permissions.  So you don't want the IAM rules that you're using for deployment potentially to be able to deploy to every single region, because then, if people get one of those roles, they can go in and do whatever the hell they want to everything in your system.  So the proper separation of concerns there is quite important.  And because AWS has a really hard concept of region isolation, some aspects you may need to script.  Things like getting machine images into each region are not as intuitive in AWS as they are in other cloud providers.  Some things- some sort of things around data transfer, and having that all transfer correctly, you may need to script, and there may be some processes where you may need to actually script them to make sure that things are consistent across different regions.  Effectively anything that you're doing manually, you want to not be doing manually when you're doing it in seven different places.

And the reasonable cost is sort of an interesting one; erm, we're not being introduced to Annie Jones, the CFO of ProductCorp, again, as most of you probably remember her by nowm but these are effectively the type of questions that Annie would be asking around this.  And Ben's previous interactions with Annie are going to inform the way that they handle this question.

Do you need to have development, staging, UAT environments running in more than one place?  Is it a case where you need to actually be able to test all of your dev code in seven different regions to make sure that it works in particular places?  Are you able to reduce the number of dev environments that you have running depending on which bolt-ons or which tiers or which setups you have in particular regions.  If some of them are identical or close, can you boil that down?  Can you just do it all with one dev environment?  And then particularly when it comes to staging environments and UAT environments, you've got questions there around regional users being able to do user acceptance testing on the particular version of their system with the latency that they should be able to expect.  You've got questions around, if you are doing cross-region data transfer, or cross-region communication, how you actually test to make sure that that works.  And that's something that you'll typically do in staging, which would require you to have at least two regions, potentially more, running.  But even then, you don't necessarily need seven different environments running in dev, staging, UAT, and prod.  So the answer to do you need some of these in more than one region might be yes, but that doesn't imply that you're going to need them in all seven regions.  And another question then is, do they actually need to be active all the time?  Like, if you need to run seven different UAT environments for users in your seven different areas, can you only run those when there are major changes that you want people to actually be able to test, and then spin them down so that you don't end up eating the cost?  Those are all questions that are very important to consider when you are looking at the cost of doing this.

Discovery and search is a fairly interesting- sort of situation to break down, because- this is the area where AWS is, hands down, the worst of the major cloud providers at this.  I actually had to go away and research how you do all of this properly, whereas Azure and GCP surface this for you really easily.  The most important weapon in your arsenal around getting stuff discoverable when you're running in multi-region is going to be to have a proper tagging strategy.  And that may mean that you're actually tagging all of your resources with the region that they're in.  You may find when you're running things in different regions, you need to actually be really- proactive around tagging things based on which environment they're part of as well, because that will potentially save you issues around- knowing what you've got running so that you can shut it down.

And there are a couple of different ways that you can enforce this.  AWS Config is- not a bad service around discoverability.  And you can actually set up Config rules to warn you if resources aren't tagged in the way that you want them to be.  Part of this is on the user side; you've got to actually come up with a tagging policy and publicise it, but you can go and get a view of what's owned by whom.  You can also do this in automation- oh, pardon me - you can also do this with automation workflows so you can actually block deployment if your tags aren't set up properly.  That's something that you can configure in probably the vast majority of pipelining software; go and have a look at tutorials on how to do that if you need to, because it will differ depending on what you're using.

With that, you can make use, then, of the Resource Groups and Tag Editor to actually go through and search all of your AWS resources, but they're not very discoverable which is why you do need that proper tagging strategy.  Tagging everything correctly is critical.  That is what will make Resource Groups and Tag Editor an actual useful tool for you.  And beyond that, you also have AWS Config's advanced search, which will allow you to go through and actually check for- resources that meet or don't meet particular standards across all of your regions.  That's a really good way to pick up if you've got stuff that's gone wrong, if you've got resources that haven't been configured correctly, if people have been going in and doing things they shouldn't have been doing.

So that's the multi-region architecture.  The second part of this is around cross-region aggregation.  Now the search aspect of discovery and search is definitely part of cross-region aggregation, but there are a bunch of other things that matter here as well.

Security and governance: you need to have a unified security posture.  And there are a couple of tools that AWS has come out with or improved recently that will really help you with this.  Control Tower, my old nemesis, does now run across multiple regions.  And that's configured to a fairly reasonable standard, so if you want to use Control Tower as a central location for everything that's now something that you can actually do.  Another very recent announcement that came out of AWS is that Security Hub actually now aggregates everything cross-region by default, so rather than having to go into, in ProductCorp's case, all of the seven regions that they're running in to actually have a look at what's going on, you just get one dashboard that Ben, or anyone else in the cloud team - or any of the Fly Money devs, for that matter - can go and look at to see what AWS is surfacing in terms of security findings.  And if you want to use either of those tools to plug into downstream systems, like your alerting system, your pager system, log aggregation systems, you can do that.

ARJEN: Cool!  Thanks Dawn.  That was a very interesting, erm, chapter in ProductCorp's life again.

DAWN: [laughs]

ARJEN: So, while we're waiting, erm, for everybody else to come up with questions, erm, you gave a good overview of a lot of the downsides of- that come with erm, r- running multi-region, and I know this question is going to be very very broad, but erm: considering all the issues with multi-region, erm, do you think it's going to be worth going multi-region next year when we get our Melbourne region?

DAWN: It's going to depend on what you're doing; I am not sure that I would necessarily advise everyone to immediately go out and replicate their workloads into the Melbourne region, but it is always useful to be able to do things like data backups in another region.  It's sometimes useful to have particular services that are really critical to your system running multi-region if you need to.  And there are also some benefits around - effectively being able to pick and choose what you want where.  There may be some scenarios where you want particular setups in- the Melbourne region rather than Sydney where latency is really important.  So, if you're running, you know, financial transaction systems, it can be really important to have that latency of seven or eight milliseconds compared to 40.  So there will be scenarios where there's a massive upside to running things multi-region, but it's not always going to be the case; as per my usual recommendation, you've got to actually understand what you're trying to do.

ARJEN: The, ah, standard AWS answer, I think, is, erm, it depends.

DAWN: [loud laughter] I would argue that's probably the standard answer with anything in tech!  But yes.

ARJEN: Yeah.  Cool!  Erm, I'm still not seeing any other questions coming in, so - erm, I do see positive comments, so all I can assume then is that your talk was awesome as always-

DAWN: [laughs]

ARJEN: -and everybody knows exactly everything they need to know about multi-region.

DAWN: Cool.  Well, I'll jump into the YouTube chat anyway, so if people do think of questions, erm, while the second talk is going, I'll be more than happy to answer them there.  Or Slack, or the usual channels.

ARJEN: Yep, cool.  Okay, thank you again Dawn.

DAWN: Thank you.

ARJEN: [inaudible]

ROB: Thank you Dawn.  That was fantastic as always.  I'm looking forward to the the novelisation of ProductCorp's stories sometime in the future, or at the very least continuing to hear about their exploits next year.

[Back to main talks repo](https://github.com/lisushka/talks)
