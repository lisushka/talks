# The AWS Multi-Region Starter Guide - Transcript

DAWN: Hello!  Once again it is good to be here, for what will hopefully be the final edition virtually of the Melbourne AWS user group for the foreseeable future!  And today, as Rob said, we are going on another detour into the world of ProductCorp, with their AWS multi-region starter guide.  First of all, I would like to acknowledge the Wurundjeri people of the Kulin Nation on whose land I am presenting from tonight.  This is, and always will be, Aboriginal land.  Their sovereignty was never ceded.

Rob has done the introduction justice as per usual but for avoidance of doubt my name is Dawn at present I am doing cloud security and devops at enabler and yes we are hiring as probably everyone else's these days and I'm really really eager to be able to holiday overseas again because the borders have been shut for nearly two years at this point and they're just starting to open and I have to go and renew an Australian passport at some point outside of work I am an occasional author and kitchen alchemist sometimes that ends really well sometimes doesn't I am also a raging sportsball fan which is why that picture of me is me and boston burns sweater so when I came here last month to talk about control tower slightly more than 12 months on from my previous presentation we had a discussion about product cause new mergers and acquisitions unit and their first target in terms of mergers and acquisitions was a payments processing company called Fly Money ProductCorp essentially they're a startup they have a head office in sydney but essentially the bread and butter of what they do is e-commerce software they have two flagship products one called sell it which is a managed online shopping platform and one called buy it which is effectively software as a service for inventory management sorts of things that retailers might need they've been around for about seven years and they run on AWS but the reality of running ecommerce software is that you have to have a payments processor in there somewhere and so ProductCorp in their infinite wisdom decided that they were going to cut out the middle man and they were going to go out and buy themselves Fly Money this small payments processing company and as you might remember from last month's talk that hasn't gone well for them so far because Fly Money is tiny they're based in Melbourne um but they operate worldwide so obviously they operate in australia new zealand that's where they came up but the really interesting thing is that there are certain parts of the world where the vast majority of payment processing and indeed the vast majority of technical interactions in general are done solely by a mobile phone regions that have effectively bypassed the desktop so we're looking here at places like east and southeast africa and that is everywhere from kenya to namibia that's a huge swathe of the continent is a really big market for Fly Money likewise a lot of south america very heavy on mobile phone usage and some areas of eastern europe and this is where Fly Money have really found their market now from last month we know that fly money's AWS set up is a bit of a disaster it consists of three AWS accounts there we are no real clear boundaries about what goes where and these three AWS accounts are running workloads in seven different regions so obviously they've got the ap southeast too they run in sydney so that's why they've got all of their sso that's why they've got all of their initial infrastructure however because a lot of the eastern european countries that they serve are in the eu they are actually running in two different eu regions they're running in era and they're running in paris thinking they're effectively being a degree of regional replication and they can root different customers through different places they also run uh instances in hong kong now the reason for that is if you're doing anything related to payments processing hong kong is actually a really large financial market for a similar reason they do also run workloads in northern virginia because it's the most stable of the us regions it's also closest to dc and so that is covering off for them effectively a lot of the asian market banking wise also covering off a lot of the US market banking wise and in terms of regions that were released recently as Fly Money have sort of noticed that a lot of their customers are around east south east africa and south america they have actually made use of a couple of AWS regions that have not been around for all that long and that those are the AWS region in sao paulo sa east one and af south one in cape town idea they're obviously being want your workloads to be really close to your customers reduce latency and also potentially get you out of hot water in terms of data protection issues unfortunately for ah our poor long-suffering friend Ben Nguyen Fly Money's regional setup is as much of a disaster as their AWS account setup was now benny's product calls head of engineering and they're very passionate about improving infrastructure in general which is probably a good thing because the task that they're taking on at this point is starting to look quite titanic they have over 10 years of experience but also fortunately for everyone at ProductCorp they've mainly worked for startups so it's not like it's the first time that they've ever seen something like this done really poorly and in a very slapdash way the first question that one kind of has to ask oneself when looking at the matter of running things in multiple AWS regions is what does region actually mean and the really interesting sort of aspect to this is that region the meaning of the word region is not the same across all of the different cloud providers and actually if you were in pretty well everyone other than AWS but certainly Azure and to a degree as well GCP region does not mean a separation of concerns in the other cloud providers it's really easy to go in and aggregate resources across regions to actually understand how all of your workloads are running and then to drill deep down and actually break things down into individual regions so that you can compare things it's also very easy to make sure that you've got consistency cross regions if that's something that you want to do however in AWS the regions are designed to be totally isolated from one another if you're in asia and I believe if you're in GCP as well although I've not played around with it as much there is no drop down like the one that you get in the AWS console that indicates that you have to actually choose a region the CLI is configured very differently you'll in certain situations be deploying things to particular regions but it is possible to go in and actually aggregate everything across regions the AWS doesn't have that same capability built in the assumption in AWS is that regions are as much as possible entirely isolated from one another it's not just accounts that have a separation of concerns regions do too now Ben has touched Azure in the past uh has dabbled in GCP and what they end up coming up with investigating the tangled mess that is Fly Money services is a wish list of things that they want and things that they want to be able to do and that starts with a few really obvious things like consistency across regions they want to make sure that everything that is being deployed is as much as possible and as much as required the same they want to discover a strategy so some way to actually make sure that what should be running in particular regions is running in particular regions to be able to check workloads across different regions and also to be able to see whether there's anything that's running in particular regions that shouldn't fit and as part of that they actually want a unified cross region search that will allow them to drill down and be able to look at particular resources across the AWS regions they want a reasonable cost for deb environments and so effectively this is a matter of obviously ProductCorp well not obviously but ProductCorp has only ever run anything in sydney so what happens now that Fly Money has been brought in and potentially you have to run seven different regions worth of dev environments Ben wants a solution for that but it is not going to involve massive cost blowouts and on the sort of cross region side as opposed to the multi-region side there are a few other things on Ben's wish list one is the ability to prevent deployments in regions that aren't being used now a fairly standard AWS recommendation that you'll see trotted out often within companies is to actually separate out your regions into different accounts so if you had workloads running in sydney and workloads running in singapore you would have a different account for the sydney resources compared to the singapore resources that makes the setup somewhat more difficult if you do choose to go down that route but even if you don't this being something that ProductCorp currently on the fence on despite it being a recommendation even if you don't you do actually want a way to turn off all of the regions that you're not using and there's I believe still 21 AWS regions so even though Fly Money operates in seven of those 21 there's still a lot of places that you don't want stuff being deployed Ben wants some way to keep track of security issues because going through into every region and actually checking what's going on manually security wise is going to be a real pain and additionally from that some sort of way to hook up the alerting systems and the pages so that they're actually getting information across region without you having to change things in seven different places I kind of hinted at this before but this effectively breaks down into two different concepts and the first one that we're going to look at is multi-region architecture this is how you actually set up your systems to be able to run them reliably scalably and consistently across multiple different AWS regions and the first important concept to understand here is workload consistency this does not mean that your workload in every single region is going to be exactly the same you may have some regions where you have way more users than others and you may need to scale accordingly however it does mean that there are a series of questions that you want to be asking yourself about how consistent your workload should be and how you want this to look and that starts with the obvious question of how close to identical are your regional setups and that's not just about size that can also be about the fact that if you're operating in say the eu there might be additional software or additional changes that you need to deploy into your systems to actually reflect the regulatory and compliance framework in different areas you might also have certain aspects of your system that you only want to deploy for particular users in particular regions if you have say a tiered pricing model and most of your high tier customers are in one particular area and so the question around that then becomes can you build a baseline that is as close to identical as possible everywhere and then go in and actually bolt on anything that's region specific and this doesn't just apply to AWS any cloud provider way you're doing cross region this or multi-region deployment this applies to and from there do you want to deploy every region at once there could be really good reasons why you do want to do this in the sense that it has you it has you doing everything in one go but there could also be really good reasons why you don't if you want to test something at a particular scale you may only want to deploy it to your smallest region with the fewest customers so that then you've got one or two CLIents that get really annoyed with you if it falls over as compared to one or two hundred or one or two thousand you may also have a situation where you only want to deploy particular changes to particularly as with the regulatory and compliance frameworks and then there's a question around how you actually move data because in some cases you'll have a set up where each of your regional workloads is entirely isolated but that's not always going to be the case and so there's a question around do you need communication across regions and if so how are you going to achieve that with some services it's really intuitive with others that can be very complex so there are a few different ways that we can look at the workload consistency piece and that really starts with as much as possible having a modular structure so you're looking to be able to script things you're looking to be able to repeat things looking to be able to define infrastructure as code so using something like cloud formation or terraform to actually produce code that you can take and deploy everywhere you can do it with terraform modules you can do it with cloud formation stacks and stack sets there's a lot of ability built into the AWS platform and built into a lot of these providers around reusability and repeatability of what you're deploying and another aspect of this that's really important is of course the ci cd peaks without pipelines you end up having to write manual run books for deployment and that may be fine when you're only deploying to one region but when you have to deploy the same thing seven times to get it into production you're greatly increasing the risk of one small error by the user throwing everything off crashing environments causing requirements around rollbacks whereas the cicd pipelines you can basically just push it all through automatically and that's also give going to give you a greater level of assurance that everything is the same in each place and if you do decide to split everything and split all your regions up into separate accounts it's worth noting the existence of an AWS tool called resource access manager which actually allows you to take some of those resources and push them out across all of your accounts not going to solve all of the region based problems we'll talk about some of those next because in short you can afford bad architecture sometimes when you're running on a region-based scale but if you do end up having to deploy multi-region that bad architecture is going to cost you exponentially more than it would if you were doing everything only in the one place and so there are a lot of patterns here that do become really important we talked about modularity you want to be able to have everything defined in one place so cloud formation stack sets terraform modules as much as possible you want all of that to be reusable you run into issues often where you have say we need to make small changes to a particular piece of infrastructure as code and you end up actually changing that in seven or eight different places rather than just having one module that you're pulling from and separate variables or one module you're pulling from and writing region specific configuration on top so that's a really big issue but there are a few others when you're running in multiple different regions zero downtime deployment becomes exceptionally important there's a massive human cost that is often not quantified around contacting people to let them know when new releases are going out scheduling those new releases and particularly if you're running in distributed areas that are distributed across the globe and don't get me started on the timezone question here it can be really intensive to have people actually go out and schedule all of those deployments out of hours if they require downtime and that can get you into a situation where that effectively becomes the manager's job or it requires a lot of coordination across different teams and that comes at the expense of system reliability and feature development so investing that initial time in zero downtime deployment which Fly Money doesn't actually have at this point is going to be a really important piece if you do need to transfer data across regions it pays to think about how you're going to do that as well and that can be very simple building on AWS tools if you're doing things like vpc peering but there are other situations where it may be a little bit more complex and it may require you to actually write some code another thing that's very important when you're running in different regions is security baselines because if someone can get into your database in region a and then they can use that same attack vector or use the same set of credentials that they've reached to get into your database in the six other regions that you're running in suddenly you have a really big problem and so part of that is about making sure that you do actually meet security standards so patching your instances dealing with really simple low-level things like preventing sql injection but part of it is also around properly handling permissions so you don't want the iam rules that you're using for deployment potentially to be able to deploy to every single region because then if people get one of those roles they can go in and do whatever the hell they want to everything in your system so the proper separation of concerns there is quite important and because AWS has a really hard concept of region isolation some aspects you may need to script things like getting machine images into each region are not as intuitive in AWS as they are in other cloud providers some things some sort of things around data transfer and having that all transfer correctly you may need to script and there may be some processes where you may need to actually script them to make sure that things are consistent across different regions effectively anything that you're doing manually you want to not be doing manually when you're doing it in seven different places and the reasonable cost is sort of an interesting one um we're not being introduced to Annie Jones the CFO of ProductCorp again as most of you probably remember her by now but these are effectively the type of questions that Annie would be asking around this and Ben's previous interactions with Annie are going to inform the way that they handle this question do you need to have development staging qat environments running in more than one place is it a case where you need to actually be able to test all of your dev code in seven different regions to make sure that it works in particular places are you able to reduce the number of dev environments that you have running depending on which bolt-ons or which tiers or which setups you have in particular regions if some of them are identical or close can you boil that down can you just do it all with one dev environment and then particularly when it comes to staging environments in uat environments you've got questions there around regional users being able to do user acceptance testing on the particular version of their system with the latency that they should be able to expect you've got questions around if you are doing cross-region data transfer or cross-region communication how you actually test to make sure that that works and that's something that you'll typically do in staging which would require you to have at least two regions potentially more running but even then you don't necessarily need seven different environments running in dead staging uat and prod so the answer to do you need some of these in more than one region might be yes but that doesn't imply that you're going to need them in all seven regions and another question then is do they actually need to be active all the time like if you need to run seven different uat environments for users in your seven different areas can you only run those when there are major changes that you want people to actually be able to test and then spin them down so that you don't end up eating the cost those are all questions that are very important to consider when you are looking at the cost of doing this discovery and search is a fairly interesting sort of situation to break down because this is the area where AWS is hands down the worst of the major cloud providers at this I actually had to go away and research how you do all of this properly whereas Azure and GCP surface this for you really easily the most important weapon in your arsenal around getting stuff discoverable when you're running in multi-region is going to be to have a proper tagging strategy and that may mean that you're actually tagging all of your resources with the region that they're in you may find when you're running things different regions you need to actually be really proactive around tagging things based on which environment they're part of as well because that will potentially save you issues around knowing what you've got running so that you can shut it down and there are a couple of different ways that you can enforce this AWS config is not a bad surface around discoverability and you can actually set up configurals to warn you if resources aren't tagged in the way that you want them to be part of this is on the user side you've got to actually come up with a tagging policy and publicise it but you can go and get a view of what's owned by him you can also do this in automation hug me you can also do this with automation workflows so you can actually block deployment if your tags aren't set up properly that's something that you can configure in probably the vast majority of pipelining software go and have a look at tutorials on how to do that if you need to because it will differ depending on what you're using with that you can make use then of the resource groups and tag editor to actually go through and search all of your AWS resources but they're not very discoverable which is why you do need that proper tagging strategy tagging everything correctly is critical that is what will make resource groups and tag are an actual useful tool for you and beyond that you also have AWS configs advanced search which will allow you to go through and actually check for resources that meet or don't meet particular standards across all of your regions that's a really good way to pick up if you've got stuff that's gone wrong if you've got resources that haven't been configured correctly if people have been going in and doing things they shouldn't have been doing so that's the multi-region architecture the second part of this is around cross region aggregation now the search aspect of discovery and search is definitely part of cross region aggregation but there are a bunch of other things that matter here as well security and governance you need to have a unified security posture and there are a couple of tools that AWS has come out with or improved recently that will really help you with this control tower my old nemesis does now run across multiple regions and that's configured to a fairly reasonable standard so if you want to use control tower as a central location for everything that's now something that you can actually do another very recent announcement that came out of AWS is that security hub actually now aggregates everything cross region by default so rather than having to go into in product course case all of the seven regions that they're running in to actually have a look at what's going on you just get one dashboard that Ben or anyone else in cloud team or any of the Fly Money devs for that matter can go and look at to see what AWS is surfacing in terms of security findings and if you want to use either of those tools to plug into downstream systems like your alerting system your pager system log aggregation systems you can do that in terms of observability and alerting on the AWS side there's only really one aspect of this of note and that is the ability to set up cloud trail trails that run in every single region which you can then aggregate to a single log group in cloud watch that operates very much the same way as the control tower security hub piece if you want to use that as a central location and plug that into somewhere else you can but otherwise you are potentially going to have to do it and go in and actually fill some of those gaps yourselves depending on how you've got your observability and alerting set up to begin with and that might mean having to actually set up yourself centralised locations for it if you can stick to cloudtrail and cloud watch you will be able to do it you can get it all to aggregate multi-region it's not quite so true for other tools particularly if you're using third-party stuff it doesn't always work out the box and finally you've got the question of actually restricting region use and this is really easy to do using service control policies um i'll go and actually circulate the link for this um but AWS has actually provided samples for how you can set up service control policies organisations in the AWS console or you can do it on the CLI with AWS organisations they've got a create policy change policy type list policy delete policy you can restrict region use via particular scps there are also some tweaks that you can do with iam to actually restrict users to being able to run in only particular regions problem with this is if you're using control tower restricting regions via scps can actually break it control tower still does not play well with a lot of the way that AWS has done things previously but if it is something that you need to do you can do it you can make it work if you're using control tower it's going to require a lot of wrangling and do at your own risk but you can make it work so that's the rough starter guide that Ben came up with after trying to get ProductCorp and Fly Money running properly multi-region I'm assuming that we will have time for questions now as per usual if you've got any questions that don't get covered my contacts are up there I do hope that if you ever have to actually deal with multi-region stuff that you don't end up having to do what Ben has done and come in and rewrite it all that you get the chance to rewrite it yourself from first principles and actually use some of the suggestions here

ARJEN: oh thanks Dawn that was a very interesting chapter in ProductCorp's life again

DAWN: [laughs]

ARJEN: so while we're waiting for everybody else to come up with questions um you gave a good overview of a lot of the downsides of that come with um running multi-region and I know this question is going to be very very broad but considering all the issues with multi-region do you think it's going to be worth going multi-region next year when we get our Melbourne region?

DAWN: It's going to depend on what you're doing I am not sure that I would necessarily advise everyone to immediately go out and replicate their workloads into the Melbourne region but it is always useful to be able to do things like data backups in another region it's sometimes useful to have particular services that are really critical to your system running multi-region if you need to and there are also some benefits around effectively being able to pick and choose what you want where there may be some scenarios where you want particular setups in the Melbourne region rather than Sydney where latency is really important so if you're running you know financial transaction systems it can be really important to have that latency of seven or eight milliseconds compared to 40. so there will be scenarios where there's a massive upside to running things multi-region but it's not always going to be the case as per my usual recommendation you've got to actually understand what you're trying to do

ARJEN: the standard AWS answer I think is um it depends

DAWN: I would argue that's probably the standard answer with anything in tech but yes

ARJEN: yeah cool um I'm still not seeing any other questions coming in so um I do see positive comments so all I can assume then is that your talk was awesome as always and everybody knows exactly everything they need to know about multi-region

DAWN: cool well i'll jump into the youtube chat anyway so if people do think of questions um while the second talk is going i'll be more than happy to answer them there or slack or the usual channels

ARJEN: yep cool okay thank you again Dawn

DAWN: thank you

ROB: thank you Dawn that was fantastic as always I'm looking forward to the the novelisation of ProductCorp's stories sometime in the future or at the very least continuing to hear about their exploits next year

[Back to main talks repo](https://github.com/lisushka/talks)
