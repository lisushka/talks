# Build from the Ground Up with AWS Control Tower

ROB: Thanks, guys.  So, up first tonight, we have Dawn.  Erm, Dawn has recorded us another presentation again - erm, she's [sic] a regular contributor now to the Melbourne AWS User Group, we're really thankful for the effort that she puts into these presentations.  Ah, so without further ado, we'll throw over to the great introduction, I hope, to Control Tower.  I'm looking forward to this one.

DAWN: Good evening!  As always, it is a pleasure to be here tonight at the AWS User Group to give this talk on one of AWS' new services; Control Tower, which will allow you to build your AWS organisations and security framework from the ground up.

I would like to begin tonight by acknowledging the Wurundjeri people of the Kulin nation on whose land I'm recording.  This is and always will be Aboriginal land, their sovereignty was never ceded, and I would like to pay my respects to their elders, past present and emerging.

Some of you probably have met me, some of you may not have done; if you haven't met me, you would want to know: who am I?  My name is Dawn E. Collett, I am an associate DevOps/SRE at MYOB - I have worn both hats.  And my aim, when I start work on Monday, is to improve the systems that I work on by close of business Friday.  It doesn't always happen, but I try.  Outside work, I am an occasional author and kitchen alchemist - sometimes that goes well, sometimes it doesn't.  I am also a raging sportsball fan, which is why that picture of me is me at Marvel Stadium.

So, in order to- actually dissect how AWS Control Tower works, we're going to look at a hypothetical use case.  I would like you to meet ProductCorp.  ProductCorp is a hypothetical product company startup, with a head office in Sydney; they were founded about five years ago, and they offer two products. The first one is a managed inventory platform software as a service called BuyIt; the second one is a managed online shopping platform called SellIt.  And most importantly for their talk, all of their infrastructure runs on AWS.

This is Ben Nguyen.  They're ProductCorp's lead cloud engineer.  They've got ten years of experience, mostly working for startups, and- part of the reason that they took this job at ProductCorp is because - a lot of the infrastructure at ProductCorp is immature and somewhat outdated, and they're very passionate about being able to get in and improve infrastructure.

So, when Ben arrived at ProductCorp, what they found was a bit of a mess.  ProductCorp had just two AWS accounts in one organisation; they had one account for all their dev services and one account for all their prod services, and- I'm guessing most of you probably know why that's a bad idea.  If you don't - roughly, look up the principle of least privilege; basically, the idea is you don't want multiple services running in the same account if you can avoid it, because you want people to have access to- the minimum possible number of things.  That means if you get hacked, then - attackers potentially only get access to one product's data as compared to two product's data.  And they do currently have some basic detective guardrails set up using service control policies, but their guardrails are not very mature.

As far as actual account access, they manage all of their access using IAM users, which is- not great for an organisation of that size, but we'll come back to that.  What's worse is that they don't require 2FA, so that means that as long as you get the username and password on those IAM users, you can go in and do whatever you want.  The security guardrails that they do have are - fairly immature and are mostly restriction based, and, very importantly for this, they don't use proactive security services like GuardDuty.  Now, GuardDuty is not directly related to - the, sort of content of this talk, but it comes back to a theme that we'll talk about a bit later.

So, Ben sits down, and they produce a plan for what they think that ProductCorp's AWS services could look like.  They - obviously have a great concern about security, and they think that the actual organisations can be structured better.  So they build this plan and they take it to Annie Jones, who's ProductCorp's CFO. She- originally worked for an auditing firm, and as the CFO, her primary focus is value for money.  The CTO has signed off on this plan, but she doesn't really know a lot about security, so- she doesn't understand the value in it.  Basically, the way that Ben sells it to her is by explaining that it's going to be a lot cheaper for them to sort out security now than it is if they potentially get hacked down the line, where they could open themselves up to - fines and reputational damage.

So Annie, upon hearing that, hires Marie Novotna to be ProductCorp's new security function.  She came from a consulting organisation that tended to work a lot with bleeding-edge AWS services, and was very much at the forefront of using new AWS services to improve security and governance practices.  She also holds multiple AWS security certifications.  So, Ben and Marie sit down together, and they form a plan for - the first phase of how they think they can improve ProductCorp's systems.

Rather than just having one OU, they're going to have four.  They're going to have a production OU, a pre-prod OU, a dev OU, and a lab OU, and restrictions on those will all be set up differently.  There's going to be an individual prod or pre-prod account for each of ProductCorp's services, which will eventually be migrated, as the development teams complete migration from the monolith application, to one AWS account per microservice.  And all the AWS accounts will talk to each other.  There will be individual dev accounts for each microservice that the teams are currently working on, and one lab account per team to allow them to spike out things that they might want to try.

Now, while Marie was working as a consultant, she worked a bit with AWS Control Tower, which is a service that was recently released to general availability, and very recently - like earlier this year - enabled in Sydney.  What Ben and Marie plan to do is to manage their entire AWS organisation using Control Tower, which will allow them to provision new accounts using Account Factory to ensure that guardrails are applied; it will allow them to- or, Control Tower will enforce those guardrails on OUs for them so that they don't have to do it themselves by setting up SCPs; and they're also going to take advantage of Control Tower's strong recommendation to set up single sign-on, and move away from IAM users to use AWS SSO.

Once they've got all the basics out of the way, they're going to leverage that basic security posture to also, lean more on proactive security services such as CloudTrail and GuardDuty, which will make them aware when there's potentially an unauthorised intrusion into their accounts. Now this is not related to Control Tower specifically, but it's something that I think Control Tower allows you to do, is to not worry about the basics of security, and use those basic guardrails that you have to then focus on- leveraging those to- basically create more of a proactive security posture.

And now that they've developed this plan, they are going to go away and actually perform the migration.  At the start of the migration, this is what their AWS organisations look like.  It's fairly basic.  Obviously, those are not - real email addresses, I've - they're test email addresses that I've used for this, and I've blocked them out for that reason.  But they have their one master payer account, and then they have an account that has all of their production services, and all of their development services.

The first step for them is to go in and deploy AWS Single Sign-On, because- as soon as you do that you remove an awful lot of security holes.  Now, Control Tower will prompt you to do that as part of the setup process, and if you're not using some kind of SSO already, like if you're using IAM users actively to access your accounts, that's something you really should be doing.  Once they've done that, they're going to go into their new- newly provisioned AWS SSO using their accounts, and enrol the master payer account in Control Tower.  What that means is that any new OUs that they create through Control Tower will start with all of the mandatory guardrails enabled, and that they can now create new accounts using Account Factory to enrol them directly in those OUs.

So, this is what the setup screen for Control Tower looks like.  It's fairly simple, there's a bit of a blurb at the top, which explains some of the basics.  Now, for anyone who's not seen a talk by me before, I do use a zoomed in screen setting, so I apologise for the fact that there's going to be information missing, and a lot of information that's split across multiple different slides - I don't really have a way to avoid that. But - you have a brief explanation of the pricing in the home region.  We'll come back to the pricing, but Control Tower itself doesn't actually cost you any money, it's the services that Control Tower provisions are what you need to be concerned about in terms of the pricing.  The reason that we're using `us-east` as the home region for this demo is that I have other things deployed in these AWS accounts, so that's the region that my SSO is set up in.

Then, you will be asked to provision a couple of shared accounts.  Now, obviously - the master account is- the master payer account - you will not be able to change that, but you'll also be asked to provision a log archive account and an audit account.  The log archive account is where- all of the information that Control Tower - you know, all of the logs of Control Tower's APIs, all of the logs of resource configurations, will go straight to that log account in an S3 bucket.  The audit account is quite important because - it's basically an account that allows your security and governance teams to assume, ah, read or write access in other AWS accounts with an audit trail.  So you don't need to give your security and compliance teams access to all of your AWS accounts if you're using Control Tower, they can assume the- ah that access through the audit account when it's necessary. So, if there's an issue with compliance, Marie can go in and have a look at one of the AWS accounts, and Ben will still be able to follow what Marie has done using that audit trail.

Then, they'll- you'll be given a brief description of the permissions that Control Tower needs to set everything up.  A lot of those are very basic, around meeting to actually be able to set up resources using AWS Config and using the service control policies, but if you do want to use Control Tower, make sure that you do take a look through those.  It's- out of the scope of this talk to really go into, but it's an important thing to know what AWS is actually deploying.

Then, Control Tower will create two OUs for you automatically.  The first one is the core OU, which contains the log archive and audit accounts that you have to create by default.  That is managed by Control Tower - you can't and shouldn't touch it.  The other one is a custom OU, which contains user-created AWS accounts.  Obviously you can have more than that, they're just giving you something to start with.  And then, if you do want to create new OUs that are enrolled directly in Control Tower, you need to do it via the landing zone page.  Any OUs that you create using the AWS organisations page that you might be used to will not be enrolled in Control Tower, and at the moment, you won't be able to enrol them.  So if you want to enroll a new OU, you need to do it through the Control Tower landing zone page.

This is what that looks like here.  As you can see, Ben and Marie have already created some of the OUs that they'll want to use, and in order to create another one, they just click on the orange button with the `Add an OU` text on it, which will bring them, effectively, to a dialog box that just asks them to put in a name.  As far as actually provisioning guardrails- that man- or, provisioning elective guardrails and strongly recommended guardrails is not something that you do here, you just set up the OU with the name.  And once Ben and Marie are done provisioning all of their OUs, this is what it looks like.  The legacy OU is going to be where they're going to enrol their existing AWS accounts.

So when they actually provision new accounts, adding the accounts directly to Control Tower is handled by the account factory.  Now that holds for both new and existing accounts, so it's exactly the same process.  So let's look at one of the new accounts that they create.  This is the production account for the BuyIt service.  You pretty much just have to give an email, you have to provide a display name for the account, which in this case is BuyIt.  You do need to designate at least one SSO user that has access to that- ah, to the account.  I haven't done that, because that will vary depending on how your SSO users are set up, but you will need to provide that information.  And then, obviously, you select the organisational unit that the account is enrolled into and that account will provision automatically with all of the guardrails on that OU enabled.

Now, provisioning of Control Tower itself takes about 60 to 90 minutes.  Provisioning of the individual accounts took, I think, between 3 and 10 minutes for me, but you're able to- monitor the process of account provisioning - through the actual- I believe this is the service control policy, erm, dialogue.  It's not one that I'm super familiar with.  But, you can go in here, it will explain to you what it is actually going on as you provision the product, and you will be able to see a description of what's going on.  Erm, the `In progress` text, once you're done, will change to `Completed`.

Now, Control Tower also has lifecycle events, which record the actions that Control Tower carries out.  They basically just show a success or failure state, and you can use them for automation.  So they are picked up - they are accessible via API.  If you want to then, once an account is finished provisioning - say, upload some things to an S3 bucket - you can do that programmatically.  And those lifecycle events are sent to CloudTrail by default.  Now - I mentioned that I use a zoomed in screen; I'm not actually going to show you what the CloudTrail for this looks like, because AWS' UI for that is so poorly designed that- I actually can't see any of the information on it.  So if you do want to find out more about that, go and check it out yourself.

Then, Ben and Marie sort of perform the rest of the security audit.  They clean up the old IAM users, ensure that they've got GuardDuty enabled, go and check to make sure that CloudTrail is actually receiving Control Tower's lifecycle events, and also enforce some extra detective guardrails on the legacy account OU during the migration process.  So - what they're basically doing here is they're leveraging the basic security posture that- Control Tower gives them to be able to delve a bit more into proactive security.  So, when you want to enable guardrails, you have to actually - rather than enabling them by OU, you have to actually go into the guardrails tab in Control Tower, and then select the guardrail that you want to enable.  In this case, we're going to enable the guardrail to disallow public access to RDS database instances, which you can do, then, just by basically selecting the OU that you want to enable it on, and hitting the `OK` button at the bottom of the page, which- you can't see because of the zoomed screen.

Now, a few days after Ben and Marie have finished setting all of this up, erm, we meet Fred Watson.  Fred Watson is a US-based black hat hacker, and he wants to get into the ProductCorp databases to steal customers' identities, because he's heard that their security is very poor.  He's also quite lazy, so a lot of the tactics that he is going to use in his attempt to get access are- fairly standard tactics that you would see from - fairly low-level hackers.  Last time I gave a talk like this, ah, someone told me that they were disappointed that I didn't get an actual hacker into it, so this time I'd figured that we'd get an actual hacker into it, and we'd see how well Control Tower manages to foil him.

So.  Round 1.  Fred bought some leaked credentials from one of ProductCorp's old IAM users, which were leaked by a disgruntled employee, from the dark web.  And he attempted to use those credentials to access ProductCorp's AWS accounts.  However, because Marie cleaned up the old IAM users as part of the security audit, Fred's attempt to get into the account fails.

Round 2.  Fred also ran a small spear-phishing campaign to get access to some credentials for some of ProductCorp's RDS databases.  Now, he attempts to use those to get into one of the- production databases, but what he finds is that because Ben and Marie enabled strongly recommended guardrails that enforce encryption on RDS instances, and made sure that all of their RDS instances in the legacy OU were in compliance, his attempt fails.

For Round 3, Fred goes back to our old friend S3, which is probably one of the most insecure services that AWS runs.  In the legacy production account, he locates a public S3 bucket, and attempts to download files from it.  Now, the detective guardrails do tell ProductCorp that this is a security issue, but because they haven't finished following up on the recommended actions yet, Fred's attempt to get in and download information succeeds.  He downloads, basically, a list of some information about staff that are working on migrating SellIt from monoliths to microservices.

However, because GuardDuty is set up to record - security events, GuardDuty records Fred's IP address.  So, when Ben and Marie get back to the office on Monday morning, and they notice that - there is a large warning saying that someone from the US has accessed this bucket outside hours, they go in and have a look at what's actually going on in the bucket.

However, because GuardDuty is set up to record - security events, GuardDuty records Fred's IP address.  So, when Ben and Marie get back to the office on Monday morning, and they notice that - there is a large warning saying that someone from the US has accessed this bucket outside hours, they go in and have a look at what's actually going on in the bucket.  Now we can see that there's the text file of staff access data; there's also an image called `hacked`.  And when Ben and Marie open that up, they come across this old chestnut, which anyone who saw my talk on Amazon Inspector will probably remember.

So, they have their PIR.  And they publish a notice explaining basically what happened, how they identify it, and how they're going to remediate those security issues.  But what's worth noting here is that the information that Fred obtained from that public S3 bucket was actually very limited.  Had he been able to get in through the IAM user, which was disabled, or the RDS instance, which was encrypted, the damage would likely have been a lot more extensive.  And that sort of illustrates what Control Tower does; in that, because it gives you a basic security posture, you can then focus on closing some of those more

ROB: Hello!  I think we're back!  Just waiting for YouTube to come back...  Sorry about that, everyone. We had a, ah, erm, our video encoder crashed!  So that's not a good thing.  [inaudible]  Yay, we're back up!  Alright, I'll bring the presentation back up.  Sorry about that again.

DAWN: He's also quite lazy, so a lot of the tactics that he is going to use in his attempt to get access are- fairly standard tactics that you would see from - fairly low-level hackers.  Last time I gave a talk like this, ah, someone told me that they were disappointed that I didn't get an actual hacker into it, so this time I'd figured that we'd get an actual hacker into it, and we'd see how well Control Tower manages to foil him.

So.  Round 1.  Fred bought some leaked credentials from one of ProductCorp's old IAM users, which were leaked by a disgruntled employee, from the dark web.  And he attempted to use those credentials to access ProductCorp's AWS accounts.  However, because Marie cleaned up the old IAM users as part of the security audit, Fred's attempt to get into the account fails.

Round 2.  Fred also ran a small spear-phishing campaign to get access to some credentials for some of ProductCorp's RDS databases.  Now, he attempts to use those to get into one of the- production databases, but what he finds is that because Ben and Marie enabled strongly recommended guardrails that enforce encryption on RDS instances, and made sure that all of their RDS instances in the legacy OU were in compliance, his attempt fails.

For Round 3, Fred goes back to our old friend S3, which is probably one of the most insecure services that AWS runs.  In the legacy production account, he locates a public S3 bucket, and attempts to download files from it.  Now, the detective guardrails do tell ProductCorp that this is a security issue, but because they haven't finished following up on the recommended actions yet, Fred's attempt to get in and download information succeeds.  He downloads, basically, a list of some information about staff that are working on migrating SellIt from monoliths to microservices.

However, because GuardDuty is set up to record - security events, GuardDuty records Fred's IP address.  So, when Ben and Marie get back to the office on Monday morning, and they notice that - there is a large warning saying that someone from the US has accessed this bucket outside hours, they go in and have a look at what's actually going on in the bucket.  Now we can see that there's the text file of staff access data; there's also an image called `hacked`.  And when Ben and Marie open that up, they come across this old chestnut, which anyone who saw my talk on Amazon Inspector will probably remember.

So, they have their PIR.  And they publish a notice explaining basically what happened, how they identify it, and how they're going to remediate those security issues.  But what's worth noting here is that the information that Fred obtained from that public S3 bucket was actually very limited.  Had he been able to get in through the IAM user, which was disabled, or the RDS instance, which was encrypted, the damage would likely have been a lot more extensive.  And that sort of illustrates what Control Tower does; in that, because it gives you a basic security posture, you can then focus on closing some of those more obvious security holes.

As far as pricing goes, as I mentioned earlier, Control Tower itself is actually completely free.  What you pay for are- the services that Control Tower uses to perform its task.  So Service Catalog, which is used for the detective guardrails, costs you US$5 per month per Account Factory portfolio, and each account then gets 1,000 free API calls per month.  After that, it costs a very, very small amount of money which I'm not going to attempt to read per API call.  Now, they'll add up, so- do make sure that you understand how the pricing works, but it's not particularly expensive. Running Config - it costs you 0.3¢ per configuration recorded in Config, and then for every resource that you provision, it's evaluated against rules.  And pricing for the rule evaluation starts at 0.1¢ per evaluation per region, and it has tiered discounts based on volume.  There are some additional charges in terms of- the charges for CloudTrail log ingestion and insights, charges for CloudWatch metrics, and charges for the log archive buckets, the S3 buckets in the log archive account.  But if you want to understand those charges more extensively, I would recommend that you check the pricing examples page, because it's very hard for me to break down in a talk.


Now, as you may have sort of gathered from what we've been discussing here, Control Tower is bleeding-edge software, and while that comes with some advantages, it comes with some disadvantages as well.  In terms of current constraints, one of the things that I- think will be on the roadmap for Control Tower is to be able to customise guardrails, which is something that you can't do at the moment.  Because if you can add in custom SCPs- to develop your own guardrails, that is going to make the utility of Control Tower much greater, because it will mean that you no longer have to provision that manually ul- using SCPs.  You can't have multi-level OUs at the moment.  Now this would potentially be an issue if you wanted to have, say, your prod OU and then, once everything is migrated over to microservices, they wanted to have an OU for BuyIt and OU for SellIt.  Currently, you can't do that.  That's another thing that- my expectation is that's going to be on the roadmap in the next 6 to 12 months, so- it may not be a concern for you if you're looking at using it in the future, but it is at the moment.

One of the things as well with Control Tower is- it kind of locks you into ClickOps because it doesn't actually have an API, so there's not a lot that you can do with it programmatically.  So if you're working in a very mature institution which does a lot of programmatic and API work around AWS, this is probably not going to be a great solution.  The one which kind of interested me is that migrating existing accounts into Control Tower isn't totally seamless.  There were a couple of accounts when I was testing this that no matter how hard I tried, I could never get in, because I was getting unknown errors.  I'd imagine that'll be fixed fairly quickly, but if you're planning on doing this now, it's something to be aware of.

So, when should you use Control Tower?  Even though it's a fairly new service, I think there are already a few really compelling use cases for this.  One of them is- sort of the use case of ProductCorp that we've looked at, which is an immature organisation that's in the process of scaling everything up.  Because if you can delegate a lot of that basic security to Control Tower, you can then get in and do a lot of the proactive security work around enabling GuardDuty, possibly more advanced SCPs, without having to worry too much about the basic things. Another use case that I think is quite compelling, even if you do have a larger portfolio, is during a significant restructure, because if you're rearranging a lot of the accounts anyway, it may not be a huge issue to move everything over to Control Tower, where you're creating new accounts, if you only have a few existing accounts to migrate.

The third use case is, if you are- part of a company that's undertaking a cloud migration, and you've brought consultants in to do it with few or no permanent support staff.  If you're part of a consulting company, this is absolutely something I think you should have in your toolbox, because there are a lot of cases where you would come in and do work for a small company where this is exactly the right thing to use.  It will allow you to set things up in a way that's very hard for people to break, and a lot of the then, sort of, low-level tasks like provisioning new accounts, that can all be done by someone just using- someone just using the console.

So this- we've reached the end of the talk.  If you do have any questions about using Control Tower, I am happy to answer them.  I was also contacted by- some of the folks at AWS who are interested in- whether they might be able to help get people who want to use Control Tower in touch with their solutions architects.  So, if that's something that you're interested in, if this has piqued your interest and you want some information on how you might use it, then use the QR code on this slide to get yourself in touch with AWS, and they'll put you in contact with a solutions architect who should be able to help.  Also, that QR code does have some speaker feedback for me.  I don't mind whether you fill that in or not - if you feel so inclined to, go ahead, if you don't, then don't.  I'm always interested to hear feedback from people, whether it be through that or personally, but whatever you prefer to do is totally fine by me.  So that concludes the talk, and I do hope that the information in this talk will at some point allow you to improve your systems by close of business Friday.



[Back to main talks repo](https://github.com/lisushka/talks)
