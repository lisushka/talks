# Automating security checks with Amazon Inspector

Good evening, everyone, I hope that you're all keeping well in these trying times, I'm here tonight to tell you a story. It is a story about a production incident. It is a story about how we debugged it and it is a story about how we resolved it. During the story, I live we'll be answering questions through the slack channel and the YouTube comments. So if you do have any questions throughout the presentation feel free to just type them in, and I will respond to them as we go so first of all, I should probably tell you a little bit about Who I am. My name is dawn. I am an associate DevOps /soe at my OB. I have worn both hats and I am something of an author automation enthusiast, the sort of phrase that I like to use to describe this is: why fix it twice when you can automate at once? If you have a production issue, I don't want to see that being something where you have run books and you deal with it every time it occurs. I want people to automate solutions and I like to see things to be fixed permanently outside of work. I am an occasional author and kitchen alchemist. Sometimes that ends really well. Sometimes it doesn't. I am also a raging sports ball fan, which is why that picture of me is me at Marvel Stadium. So the story that I'm going to tell you tonight starts with warning. This warning came not from someone that I was employed with, but from a friend of mine who is fairly well connected to a security landscape in IT, and particularly in terms of Microsoft products. They basically warned me that there was a zero-day vulnerability that was about to come out from Microsoft and told me that when I went into work the next day, I should make sure that we patched all of our instances. So I filed that information away, get into work the next day and sure enough. As soon as I arrived into work, it is announced that there has been a zero day, vulnerability from Microsoft and part of the zero day. Vulnerability that was disclosed is a vulnerability that targeted the Remote Desktop Protocol, which allows you to remote into machines that are hosted somewhere else from your local computer. That vulnerability allowed arbitrary code execution and I'm fairly sure that everyone here will have some understanding of. Why that could potentially be an issue? So my colleagues and I with the warning in mind, sat down. We looked at what we were working with, try to get our head around it, and then we got to work effectively. The problem that we were dealing with without wanting to give away too much about our production infrastructure was that we had workloads running on Amazon, ec2 instances which were accessible via remote, desktop protocol and in some cases, when you have workloads that are accessible through ec2. There are effectively accessible to the whole internet now. The way that you lock, that down, is by using security rules on your V, pcs and security rules on your security groups, which will lock that access down to a subset of IP addresses, usually you'd, be looking at a corporate VPN. The problem with that is that if you mess that up, then those instances can potentially be open to the entire Internet, as many people in this industry have found out at various points to their detriment. So, in order to actually resolve this issue, what we basically needed to know was not: how are we going to take these instances down and immediately patch them? It was more. Could someone have exploited the vulnerability already? Have we got configurations that are potentially open to the Internet and how much time do we have to patch our instances and is there any quick fixes that we can come up with that will actually buy ourselves some time to plan out our patching strategy work out? What we want to do, and not have to just take instances down in the middle of the day, which is what we would potentially have had to do if we were responding to this reactively enter Amazon inspector effectively. Amazon inspector is a tool that you can use to check the security of a situ instances, so at its simplest it will scan for Network related issues like do you have any ports that are open to the Internet? Do you have methods of access that should be locked down and in its more complex form, it can actually look at? Are you running software that doesn't meet security best practices? You know, are you running software that has known vulnerabilities in it and it's something that can be used both proactively and reactively, so you can automate it. You can integrate it into your build pipelines we'll get to that later. But in this case we wanted to use reactively, so we basically wanted to just run a quick check, see whether there were any security issues that we could solve quickly, which would then bias time to sit down and plan out how we were going to take the Instances offline now, Amazon inspector has different tiers of recommendations. You'Ve got high risk recommendations, medium risk recommendations, low risk recommendations, any informational recommendations. The high tier findings are sort of the really egregious misconfigurations the okay. These are things that you need to respond to immediately. All your ports are open to the Internet. That'S a problem medium and low tier findings are generally things that you should investigate. Understand why it is that you're getting those warnings back. Some of those may be acceptable, depending on the way that your instances are configured and what you're trying to actually do with them. But generally those are the sorts of things that you want to look into and see. Can you improve this informational findings indicate a potential security issue? That'S not currently active, but they are findings that you can sort of look at and we'll give you some more information about where you might focus your efforts in the future and the best thing that I'm as an inspector is it's really easy to get started with It so here we're looking at a screenshot from an AWS account that is never used inspected before you get a page that gives you some information on what it does and how to use it. Most of that's cut off because of my screen resolution, but in order to get started with this, we just need to hit the button in the middle of the page that says get started and that will bring us to a view that looks something like this. So we note here that Amazon inspector has two different types of assessments that we can run. We can run networkers and we can run host assessments, so the network assessments are basically just looking at the networking configuration in the sense of you know. Do we have ports that globally reachable that shouldn't be have we got a VP C? That'S perhaps not locked down. Have we got instances that should be private, but are actually public and those sorts of things, and we also have host assessments, which are a little bit more complex and cost a little bit more we'll get into the pricing later, which are looking for things like known, Vulnerable software and our benchmarking, your instances against security, best practices. Now there is also an option for some advanced configuration. So, let's briefly take a look at that. What we see here is this basically allows you to configure what you're actually doing a bit more fine-grained. So maybe you want to look at security best practices, but you don't want to look at common vulnerabilities. You have the option to cut down sort of the scope of what it is that you're, actually that you're actually looking at - and you can do all of that here, but for the purposes of this, what we're going to do is we're just going to take it And we're going to run the standard assessment now you can't see it again because of my screen resolution, but at the bottom of the page you have the option to run Amazon inspector once or to schedule it to run. Weekly scheduling it to run weekly is something that's good if you want to get constant updates on what your security posture looks like, you can also integrate it into your CI CD pipelines. Again, that's something that we're going to look at later, but for now we're just going to run this once and see what the findings are that we get back now. What I've done is I've created a couple of ec2 instances which are configured in ways that will basically give us findings back, so Amazon inspector will take a couple of minutes to run, and then we can have a look at the findings now, as we can see That we've got a couple of informational findings. We'Ve got a couple of auto risk findings. We'Ve got a medium risk finding. So if we take a look indeed at one of those low-risk findings, what we actually find here is - or this is one of the informational findings - what we actually find here is it's telling us. We have these groups of ports that are open to the internet. Now, in some situations, that would be a concern, but what this setup actually is is it's taken from something that I did for AWS programming tools and it's the setup that you would use to run an open source, video conferencing, software called bigbluebutton on ec2, so that Large range of UDP ports, that's open! That range is open because bigbluebutton requires it to be open in order to be able to pass video and audio information through the software. So in this case, although we are getting an alert back, this is working as intended. However, if we go and take a look at that, medium risk alert that we had, which is one of the ones that you probably be concerned about. What we find here is that that's TCP port 22, which is the SSH port, which is open to the Internet and again, when you're dealing with vulnerabilities that could potentially cause iris recode execution. I'M sure I don't need to explain to everyone why this configuration is a bad idea, so we've seen now what Amazon inspectors findings will generally look like. Let'S take this one step further and let's actually automate it into a CI CD pipeline. Now for this I am using as your pipelines, and I recognize that, considering that this is an AWS meetup, this is a little bit sacrilegious. There are a couple of reasons why I'm doing that, though? The first one is, as your pipelines is very simple, and surprisingly, it actually integrates really well with AWS, with some of the tools that have been built in the azure pipeline's marketplace. But the main reason that I'm doing this is that, as your pipelines has a free tier and is also free for open source, so I can throw all of this code up on github, which I have done, and you can then fork it and try it yourself. In as your pipelines, without having to pay anything, if you want to take a look at that code, the link is here now having a look at what the pipeline actually does. We'Ve got a cloud formation stack that runs basically sets up to instances and they look very similar to the instances that we had in the previous slides. We'Ve got one which uses the standard configuration for bigbluebutton we've got another one that is using a configuration where port 22 is open to the internet, and both of these instances in this case are tea to micros. So as long as you spin them down, they will be covered by the fruit here and they won't. Actually, you won't actually be charged for it and then, once the as your pipeline runs that cloud formation stack, then we're doing a scan using the Amazon inspector API. That will actually bring us back and will show us what is going on and what the security recommendations are. So if we run that pipeline and I was going to try and do a video demonstration here, but unfortunately I wasn't able to get it to hook up. But let's just take a look at some screenshots of what we actually get back so from the build steps. If we go in and actually take a look here, we can see that the API has run its assessment. Once the cloud formation stack was complete and we've got a response back from it and we can go in here and have a look at okay. So we've got this nice structure, it's telling us, as we saw earlier, we've got a medium finding. We'Ve got two low findings and we've got two informational findings and then you can open that up and basically get all of the information back now. The pricing for Amazon inspector is actually quite reasonable. I know I mentioned it a couple of times earlier, but it's based on two different things. So, first of all, it's based on the number of ac2 instances that you're actually scanning the size is completely irrelevant. In this case, we're only worried about the number of instances that you're scanning, and the second thing that we're looking at is the type of assessment. So when we were looking at the assessments earlier, we saw that there were assessments for Network reach ability rules and that there were assessments for hosts assessment rules. So the pricing for those is different. However, it is worth noting that, for both of those types of assessments, the first 250 assessments that you do are free so, depending on the size of your production workload, that will give you a chance to test it out. For a couple of weeks get your head around, it actually does and see whether this is an appropriate tool for you to be using once you hit those 250 assessments. You then end up with pricing on a monthly basis, so for the network rules assessments, the first 250 assessments cost you 15 cents. The next 750 cost you 13 cents. The next 4,000 cost you 10 cents, the next 45 thousand after that cost you 7 cents and after that, all assessments cost you 4 cents, so you're, looking at a maximum of 15 cents per instance and the larger your workload is, the more you're running Amazon inspector. In a month, the cheaper those assessments are going to become so for the host assessment rules they're a little bit more expensive, and that's because you need to have an agent installed on your instances and the analysis that they're doing is a bit more complicated sort of A bit more complex in terms of compute power, but even then for the first 250 assessments per month, you're only looking at 30 cents per instance for the next 750, it's 25 cents for the next 4,000. After that, it's 15 cents for the next 45,000, it's 10 cents and all assessments after that are 5 cents. So that means that to run the full suite of Amazon inspector assessments on an instance, the maximum amount that that's ever going to cost. You is 45 cents per instance, and again the first 250 assessments are free, so that will allow you to run it against your production workload and get a feel for whether it's an appropriate tool for you to use. You really do by the way, have to be running a lot of instances to hit that 50k threshold, or you have to be running Amazon inspector very frequently like have an integration into a CI CD pipeline. That'S running multiple times a day. I have seen production workloads where the cost of running Amazon inspector in production, even in bundled into a CI CD pipeline, only ends up being about 10 to 12 dollars a month, and obviously all of these prices are in US dollars. So you do have to be aware of the fact. Obviously, if we're talking about Australian dollars and exchange rates, it's going to be a little bit more expensive. There are also a couple of tools that you can use to understand what the AWS pricing might look like. Aws has a pricing calculator, so if you know what your production workload looks like, if you know how many times a month, you're likely to be running app as an inspector, you can plug that in and it will give you an approximate cost. Aws also has a total cost of ownership calculator and that will allow you to basically work out the cost for your entire workloads. So before I finish up, there are a couple of other things that I want to talk about, and one of them is the sort of cost-benefit analyses that we have to actually do here. The thing about Amazon inspector is that the sliding scale means that, if you have really large workloads they're going to cost you less per instance. If you are going over that 50 thousand assessments per month, you're talking less than 10 US cents to actually run that assessment, which is not too bad - and the other thing that you have to remember is that proactive use of inspector can potentially actually avoid security issues. So in that respect, it acts in much the same way as guard duty in that, if you have issues you're going to be made aware of them before they potentially become an issue, and when you deal with sort of production issues like the ones that we had Checking those incidents manually takes a lot of engineers time and it takes a lot of money to actually do that and if something goes really wrong and someone manages to get into one of your instances that is potentially going to cost you a lot more money, then, And particularly on large workloads manual checks might well end up missing issues, so that's something that you sort of have to be aware of then. The other thing that I want to talk about is sort of in terms of the use case that I had where we were dealing with an issue where Amazon inspector we were basically using it to buy ourselves time. The thing with that is that, even if you're using them as an inspector reactively again, it's analyzing those instances manually takes a lot of engineers, time and a lot of money, and what you're really worried about in terms of those analyses is not so much okay, we Need to you know in deal with this. What you're trying to do is basically pick the low-hanging fruit so resolve any issues that you can resolve quickly, which will then allow you time to make a coordinated plan to actually bring the instance down and patch it, which, in that case of the production issue, is What we ended up doing so, to recap, Amazon inspector, is a tool. That'S basically used for checking security of ec2 instances that includes both network security and security of any programs that might be running on the actual machine, including the operating system. It'S something that can be used both proactively and reactively in that with in AWS. You can schedule it or you can run it once. If you have a security incident and you need to respond to it, you can chat with in AWS. You can change a lot weekly. You can also automate it into your build pipeline so that it runs every time you have a production deployment. Now, what that actually allows you to do is to look at the configuration and go. Ok. Are there any issues here where something has gone wrong? Someone has potentially misconfigured a cloud formation template and then you're able to respond to that rather than having it become more of an issue down the line and the maximum that you're ever going to pay, for this is 45 cents, 45 US cents per incidents to run Those scans, if your work ID is very small. It'S going to be fairly cheap to run this if you are running the simpler scans, so just the network assessments again, it's going to be cheaper than running the full hosts assessment to find out whether there's any vulnerable programs on that machine and the first 250 scans Are free, which does give you an opportunity to look at you know? Is this the right tool for our organization? Does this actually do what we want it to do, and provided that your production workload is not exceptionally large? That will give you the chance to try it for maybe two three weeks see how you feel about it. So we've reached the end of the presentation tonight, I'm whether this is probably not covered everything, but I'm hoping that this is a really good basic introduction to Amazon inspector and why you might want to use it. I imagine that I have been answering questions in the comments as we've gone, but if you do have any more questions now is the time to ask them so feel free to ask them either in the slide channel or the YouTube comments, and I will respond accordingly. Otherwise, it has been lovely to record this talk for all of you to listen to tonight. I hope to get some good feedback on this. I hope that it has given you some information that you can then take back to your workplaces, and I hope that I will converse with you and potentially see some of you in the future once we're out of isolation cool. Thank you very much dawn for that that was record a little bit earlier, but she has joined us on on skype. To answer some questions. Let'S see if I can find the right button here, we go here, we go dawn. Can you hear me no hang on? Try now what going on at once, all of the ones there yeah so we've had a few questions come through in the YouTube channel. I'Ve seen you've been answering them as well, but we probably really go through them a little bit here for the benefit of people who might be watching this later. Yes, I get helps if I get in my box on the screen. So first question: first question was from Simon McKinnon, so when you, when you do your inspector runs, is that done via the the console or was a via the CLI? So for this talk, I used a combination of both the first time that I actually introduced the here's. What the console looks like I did that first run in the console when I and at the stage that Simon had had asked that question. We hadn't actually been through the pipeline section of the talk. Yet that's all done through the AWS CLI. So if you go and look at the azure pipeline's file for that - and yes, I do know - that's a bit sacrilegious if you go and look at the other pipelines file for that, it's using the AWS CLI tasks to run those to run those those counts. Awesome and that's all right, you can use as your pipelines around here. I used a lot of github app tracksuits myself, so so a second question was from guy Morton. Do you mean that the assessment from 1 to 250 was $ 0 and then everything after is 15 cents each so effectively? The the clarification for that is that the first 250 assessments basically are a free trial, in the same sense that the AWS free tier is or guide, and that's the first 250 assessments ever and then in rolls over to monthly pricing, which is basically a price per Instance and you get discounts discounts for running it on a large volume of instances. Every month, discounts per instance. I hesitate to add okay, so, unlike the normal free thinking up everything in the chat anyway, I mean you'll be around for the rest of the nights. It ends there anymore. If there are any more I most certainly will be, and if you are interested in having a go with it, I will be linked to the github, the github for the pipeline's demo, but I did was on the slides. I will also put it in the YouTube chat and I will put it in the slack channel. My intention is over the next 3-4 weeks to try and build that out into something more fully fleshed. My feeling from having played with it is that particularly the CLI, for this is not very mature, so I'm going to go away and see whether I can do a bit of scripting to fill some of the holes in the way that the sale I works at The moment so, if you're interested in it do take a look at that cool, I definitely will is something that I haven't really had the chance to look into myself, but is something that's, as you say, it's definitely worth being on the front foot with security. Yes helps you do that most definitely great. Thank you very much for tonight dawn, not a problem. Well, don't you you a bit later? Yes, 
