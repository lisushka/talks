# Automating security checks with Amazon Inspector - Transcript

DAWN: Good evening, everyone.  I hope that you're all keeping well in these trying times. I'm here tonight to tell you- a story. It is a story about a production incident, it is a story about how we debugged it, and it is a story about how we resolved it.  Ah, during the story, I, live, we'll be answering questions- through the Slack channel and the YouTube comments, so if you do have any questions throughout the presentation, feel free to just type them in, and I will respond to them as we go.

So, first of all, I should probably tell you a little bit about who I am. My name is Dawn.  I am an associate DevOps/SRE at MYOB - I have worn both hats - and I am something of an auth- automation enthusiast.  The, sort of, phrase that I like to use to describe this is: why fix it twice when you can automate it once?  If you have a production issue, I don't want to see that being something where you have runbooks and you- deal with it every time it occurs.  I want people to automate solutions, and I like to see things to be fixed permanently.  Outside of work, I am an occasional author and kitchen alchemist; sometimes that ends really well, sometimes it doesn't.  I am also a raging sportsball fan, which is why that picture of me is me at Marvel Stadium.

So - the story that I'm going to tell you tonight starts with a warning. And this warning came not from someone that I was employed with, but from a friend of mine who is fairly well connected to the- security landscape in- IT, and particularly in terms of Microsoft products.  They basically warned me that- there was a zero-day vulnerability that was about to come out from Microsoft, and told me that, when I went into work the next day, I should make sure- that we patched all of our instances.  So, I- filed that information away, get into work the next day, and sure enough, as soon as I arrive into work, it is announced that there has been a zero-day vulnerability from Microsoft, and- part of the zero-day vulnerability that was disclosed is a vulnerability that targeted the Remote Desktop Protocol, which allows you to remote into machines that are hosted somewhere else from your local computer.  That- vulnerability allowed arbitrary code execution, and I'm fairly sure that everyone here will have some understanding of why that could potentially be an issue.  So, my colleagues and I, with the warning in mind, sat down.  We looked at what we were working with, tried to get our head around it, and then we got to work.

Effectively, the problem that we were dealing with, without wanting to give away too much about our production infrastructure, was that we had workloads running on Amazon EC2 instances which were accessible via remote desktop protocol, and - in some cases, when you have, ah, workloads that are accessible through EC2, they are effectively accessible to the whole internet.  Now, the way that you lock that down is by using security rules on your, ah, VPCs and security rules on your security groups, which will lock that access down to- a subset of IP addresses.  Usually ,you'd be looking at a corporate VPN.  The problem with that is that if you mess that up, then- those instances can potentially be open to- the entire Internet.  As many people in this industry have found out at various points, to their detriment.

So, in order to actually resolve this issue, what we basically needed to know was not, how are we going to take these instances down and immediately patch them?  It was more, could someone have exploited the vulnerability already, have we got configurations that are potentially open to the Internet, and how much time do we have to patch our instances?  And are there any quick fixes that we can come up with, that will actually buy ourselves some time to plan out our patching strategy, work out what we want to do, and not have to just take instances down in the middle of the day, which is what we would potentially have had to do if we were responding to this reactively.

Enter Amazon Inspector.  Effectively, Amazon Inspector is- a tool that you can use to check the security of EC2 instances.  So- at its simplest, it will scan for- network-related issues, like, do you have any ports that are open to the Internet, do you have methods of access that should be locked down?  And in its more complex form, it can actually look at are you running software that doesn't meet security best practices, you know, are you running software that has known vulnerabilities in it?  And it's something that can be used both proactively and reactively, so you can automate it, you can integrate it into your build pipelines - we'll get to that later - but in this case, we wanted to use it reactively, so- we basically wanted to just run a quick check, see whether there were any security issues that we could solve quickly, which would then buy us time to- sit down and plan out how we were going to take the instances offline.

Now, Amazon Inspector has different tiers- of recommendations.  You've got high-risk recommendations, medium-risk recommendations, low-risk recommendations, and informational recommendations.  The high-tier findings are- sort of the really egregious misconfigurations; the okay, these are things that you need to respond to immediately, all your ports are open to the Internet, that's a problem.  Medium and low-tier findings are generally things that you should investigate, understand why it is that you're getting those warnings back.  Some of those may be acceptable, depending on the way that your instances are configured and what you're trying to actually do with them, but generally those are the sorts of things that you want to look into and see, can you improve this?  Informational findings indicate a potential security issue that's not currently active, but- they are findings that you can sort of- look at and will give you some more information about where you might focus your efforts in the future.

And the best thing that Amazon Inspector is it's really easy to get started with it.  So, here we're looking at a screenshot from an AWS account that has never used Inspector before.  You get a page that gives you some information on- what it does and how to use it - most of that's cut off because of my screen resolution - but- in order to get started with this, we just need to hit the- the button in the middle of the page that says `Get Started`.  And that will bring us to- a view that looks something like this.

So we- h- note here that Amazon Inspector has two different types of assessments that we can run; we can run network assessments and we can run host assessments.  So the network assessments are basically just looking at the networking configuration, in the sense of, you know, do we have ports that globally reachable that shouldn't be, have we got a VPC that's perhaps not locked down, have we got instances that should be private but are actually public, and those sorts of things.  And we also have host assessments, which are a little bit more complex and cost a little bit more - we'll get into the pricing later - which are looking for things like known vulnerable software and are benchmarking your instances against security best practices.

Now, there is also an option for some advanced configuration, so let's briefly take a look at that.  What we see here is- this basically allows you to configure what you're actually doing a bit more fine-grained.  So maybe you want to look at security best practices, but you don't want to look at common vulnerabilities, you have the option to- cut down, sort of the scope of what it is that you're actu- that you're actually looking at, and you can do all of that here.  But for the purposes of this, what we're going to do is we're just going to take it and we're going to run the standard assessment.  Now- you can't see it, again, because of my screen resolution, but at the bottom of the page you have the option to run Amazon Inspector once or to schedule it to run weekly.  Ah, scheduling it to run weekly is something that's good if you want to- get constant updates on what your security posture looks like.  You can also integrate it into your CI/CD pipelines - again, that's something that we're going to look at later, but for now we're just going to run this once, and see what the findings are that we get back.

Now, what I've done is I've created a couple of EC2 instances which are configured in- ways that will basically give us findings back.  So, Amazon Inspector will take a couple of minutes to run, and then we can have a look at the findings.  Now, as we can see there, we've got a couple of informational findings, we've got a couple of low-risk findings, we've got a medium-risk finding.  So if we take a look, a- indeed, at one of those low-risk findings, what we actually find here is - or this is one of the informational findings - what we actually find here is it's telling us we have these groups of ports that are open to the Internet.  Now, in some situations that would be a concern, but what this setup actually is is it's taken from something that I did for AWS Programming and Tools, and it's the setup that you would use to run an open-source video conferencing software called BigBlueButton on EC2.  So that large range of UDP ports that's open, that range is open because BigBlueButton requires it to be open in order to be able to parse video and audio information through the software.  So in this case, although we are getting an alert back, this is working as intended.  However, if we go and take a look at that medium-risk alert that we had, which is one of the ones that you probably be concerned about, what we find here is that that's TCP port 22, which is the SSH port, which is open to the Internet.  And - again, when you're dealing with vulnerabilities that could potentially cause arbitrary code execution, I'm sure I don't need to explain to everyone why this configuration is a bad idea.

So, we've seen now what Amazon Inspector's findings will generally look like - let's take this one step further and let's actually automate it into a CI/CD pipeline.  Now, for this I am using Azure Pipelines, and I recognize that, considering that this is an AWS meetup, this is a little bit sacrilegious.  There are a couple of reasons why I'm doing that, though.  The first one is, Azure Pipelines is very simple, and surprisingly, it actually integrates really well with AWS, with some of the tools that have been built in the Azure Pipelines marketplace.  But the main reason that I'm doing this is that - Azure Pipelines has a free tier, and is also free for open-source.  So, I can throw all of this code up on Github, which I have done, and- you can then fork it and try it yourself in Azure Pipelines, without having to pay anything.  If you want to take a look at that code, the link is here.

Now - having a look at what the pipeline actually does, we've got a CloudFormation stack that runs- basically sets up two instances, and they look very similar to the instances that we had in the previous slides; we've got one which uses the standard configuration for BigBlueButton, we've got another one that is using a configuration where port 22 is open to the internet  and both of these instances, in this case, are `t2.micro`s, so as long as you spin them down, they will be covered by the free tier, and they won't actually- you won't actually be charged for it.  And then, once the Azure Pipeline runs that CloudFormation stack, then we're doing a scan using the Amazon Inspector API - that will actually bring us back and will show us what is going on and what the security recommendations are.

So, if we run that pipeline - and I was going to try and do a video demonstration here, but unfortunately I wasn't able to get it to hook up - but let's just take a look at some screenshots of what we actually get back.  So, from the build steps, if we go in and actually take a look here, we can see that the API has- run its assessment once the CloudFormation stack was complete, and we've got a response back from it.  And we can go in here and have a look at - okay, so we've got this nice structure, it's telling us - as we saw earlier, we've got a medium finding, we've got two low findings, and we've got two informational findings.  And then you can open that up and basically get all of the information back.

Now, the pricing for Amazon Inspector is actually quite reasonable; I know I mentioned it a couple of times earlier, but - it's based on two different things.  So, first of all, it's based on the number of EC2 instances that you're actually scanning; the size is completely irrelevant in this case, we're only worried about the number of instances that you're scanning; and the second thing that we're looking at is the type of assessment.  So when we were looking at the assessments earlier, we saw that there were assessments for Network reach ability rules, and that there were assessments for host assessment rules.  So, the pricing for those is different.  However, it is worth noting that, for both of those types of assessments, the first 250 assessments that you do are free.  So, depending on the size of your production workload, that will give you a chance to- test it out for a couple of weeks, get your head around what it actually does, and see whether this is an appropriate tool for you to be using.

Once you hit those 250 assessments, you then end up with pricing on a monthly basis.  So, for the network rules assessments: the first 250 assessments cost you 15 cents, the next 750 cost you 13 cents, the next 4,000 cost you 10 cents, the next 45,000 after that cost you 7 cents, and after that, all assessments cost you 4 cents.  So, you're looking at a maximum of 15 cents per instance, and the larger your workload is, the more you're running Amazon Inspector in a month, the cheaper those assessments are going to become.  So, for the host assessment rules, they're a little bit more expensive, and that's because you need to have an agent installed on your instances and the analysis that they're doing is a bit more complicated - sort of, a bit more complex in terms of compute power.  But even then for the first 250 assessments per month, you're only looking at 30 cents per instance.  For the next 750, it's 25 cents, for the next 4,000 after that it's 15 cents, for the next 45,000 it's 10 cents, and all assessments after that are 5 cents.  So that means that to run the full suite of Amazon Inspector assessments on an instance, the maximum amount that that's ever going to cost you is 45 cents per instance.  And again, the first 250 assessments are free.  So that will allow you to run it against your production workload and get a feel for whether it's an appropriate tool for you to use.

You really do, by the way, have to be running a lot of instances to hit that 50k threshold, or you have to be running Amazon Inspector very frequently, like have it integrated into a CI/CD pipeline that's running multiple times a day.  I have seen production workloads where the cost of running Amazon Inspector in production, even in- bundled into a CI/CD pipeline, only ends up being about - nn, 10 to 12 dollars a month.  And obviously - all of these prices are in US dollars.  So - you do have to be aware of the fact, obviously, if we're talking about Australian dollars and exchange rates, it's going to be a little bit more expensive.  There are also- a couple of tools that you can use to understand what the AWS pricing might look like; AWS has a pricing calculator, so if you know what your production workload looks like, if you know how many times a month you're likely to be running Amazon Inspector, you can plug that in and it will give you an approximate cost.  AWS also has a total cost of ownership calculator, and that will allow you to basically work out the cost for your entire workloads.

So, before I finish up, there are a couple of other things that I want to talk about.  And one of them is- the sort of cost-benefit analyses that we have to actually do here.  The thing about Amazon Inspector is that the sliding scale means that, if you have really large workloads, they're going to cost you less per instance.  If you are going over that 50,000 assessments per month, you're talking less than 10 US cents to actually run that assessment, which is not too bad.  And the other thing that you have to remember is that proactive use of Inspector can potentially actually avoid security issues, so in that respect, it acts in much the same way as GuardDuty, in that, if you have issues, you're going to be made aware of them before they potentially become an issue.  And when you deal with sort of production issues like the ones that we had, checking those incidents manually takes a lot of engineers' time, and it takes a lot of money to actually do that.  And if something goes really wrong, and someone manages to get into one of your instances, that is potentially going to cost you a lot more money then.  And particularly on large workloads, manual checks might well end up missing issues, so that's something that you sort of have to be aware of.

Then, the other thing that I want to talk about is sort of- in terms of the use case that I had, where we were dealing with an issue where Amazon Inspector, we were basically using it to buy ourselves time - the thing with that is that, even if you're using them as an Inspector reactively, again, it's- analyzing those instances manually takes a lot of engineers' time and a lot of money, and what you're really worried about in terms of those analyses is not so much, okay, we need to, you know, immediately deal with this.  What you're trying to do is basically pick the low-hanging fruit, so resolve any issues that you can resolve quickly, which will then allow you time to make a coordinated plan to actually bring the instance down and patch it, which, in that case of the production issue, is what we ended up doing.

[Back to main talks repo](https://github.com/lisushka/talks)
