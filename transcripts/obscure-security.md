# Obscure Security on Kubernetes - Transcript

DAWN: Hello everyone!  Ah, it's been a while since I've been here, erm, and - I do appreciate that Rob has said that I need no introduction.  I have indeed been working more on security lately, and so today, I would like to take you through 'Obscure Security on Kubernetes'.  Do you have no idea what that means?  Cool!  Because I also had absolutely no idea what that meant, until I started delving into the wold of Kubernetes security.  So let me take you through it.

First of all, I would like to acknowledge the Wurundjeri people of the Kulin Nation, on whose land I am presenting today.  This is, and always will be, Aboriginal land.  Their sovereignty was never ceded.

Er - so I'm not going to take Rob at his word, in saying that I need no introduction.  For those of you who don't know me, my name is Dawn, and - I do a bit of everything, but at the moment, it's chiefly DevOps and cloud security that I am working on.  Just to illustrate the level of paranoia that's required to do a lot of this security work, I was not actually in the Facebook data breach that happened earlier this year, because I have never had a Facebook account.  Because as far as I'm concerned, they are a minefield of security problems.  Outside of work, I am an occasional author and kitchen alchemist.  I am also a raging sportsball fan; to that end, I have updated my speaker picture, so now, rather than being at Marvel Stadium, I'm wearing a hockey sweater instead.

So, you're setting up a Kubernetes cluster, and you want to know what you need to know about Kubernetes security.  And probably, if you are doing that, you are going to take yourselves off to the Internet and have a look at some articles about it.  What you'll find is a list of things, typically, that looks something like this.

Generally, the first cab off the rank will be external access restrictions.  Because when you set up your Kubernetes cluster out of the box, particularly if you're setting up a bare-metal cluster on your own hardware or on EC2 instances, a lot of things like the API server, and certain aspects of the- underlying structure will be open to the Internet by default.  And so, it will be suggested that the first thing you should probably do is turn that off.  Then, you have to look at, when you're actually getting to deploying workloads, how security works there.  So, when you're getting to deploying your first workloads, one of the very common recommendations that you will see is your pods all need security policies; and it's surprising how many people forget this, but - in your average enterprise, that's going to be something that everyone very much does.

Something that, ah, doesn't necessarily happen, though, is that - with Kubernetes out of the box, all of the pods on your system have some degree of interoperability, so they have some degree of being able to talk to each other.  If you want to restrict that, you'd need to set up a `NetworkPolicy`, which will shut down cross-pod communication.  Another very important thing is - in terms of the underlying structure of the Kubernetes cluster, your `etcd` drive has a lot of really important information on it, and that, by default, is not encrypted.  So, you don't really want people sniffing all of the secrets around your cluster, so you probably want to encrypt that, and you probably want some sort of monitoring in place, to make sure that nobody is making changes to it.

In terms of secrets management, er, obviously you don't want to be storing your secrets in Github or storing them directly in whatever you're using to deploy workloads, so the recommendation then will be that you set up some sort of secrets management.  Ah, you've got HashiCorp Vault, which is one that is very easy to install on a Kubernetes cluster and is open-source.  Alternatively, if you're in the AWS ecosystem, you can use the AWS Key Management Service as an alternative, and that will allow you to encrypt - any secrets that you might need, but also things like certificates that you would use for mutual TLS traffic.  In terms of authentication and authorisation, there's really only one thing to say here, which is that you need some form of role-based access control - you don't want to be giving everyone an admin token to your cluster, and you don't want everyone to have exactly the same permissions, and you don't want to be manually assigning permissions per user.  Fortunately, though, if you are using EKS, because EKS is backed by IAM roles, to some degree that role-based access control is built-in.

'But Dawn,' you say to me, 'this is a level 300 talk, so I already know a lot of these basic security things about Kubernetes.  Why are you telling me all of this?'  Well - because there are a few common gotchas, and some of these common gotchas actually lead us to talking about the topic at hand.

The obvious one, which is a bane in the life of any security person is, what happens when someone actually leaves your organisation?  Obviously, with AWS, this is not too difficult to manage if you - if you're hooked up to SSO, but, if you're doing anything bare metal in terms of role-based access control, you do actually have to have policies for what you're going to do when someone leaves the organisation to make sure that their Kubernetes access actually gets revoked, particularly if the majority of your workloads are running there.  And then you've got questions around things like - how are you doing access control for your secrets?  Because if you're using something like HashiCorp Vault, you really don't want to be giving everyone in the organization a root token, you want to make sure that you actually know who is signing into the Vault and who is changing things.  Likewise for KMS - again, it's a little bit easier because- a lot of that will be pre-configured, but you do want to make sure that you've actually shut down control over things.  Then you sort of have to worry about- not just the Kubernetes system data, and `etcd` and a lot of those other drives, but- if you have data stores that are inherent to any of your Kubernetes workloads, what are you going to do to secure those? So do you need to encrypt them, how do you make sure that they're not accessible to the whole Internet?

How are you protecting against misconfigurations, and how often do you review your security posture?  Now, these are the two really interesting ones in my view, because if you go away and look at - a lot of the things that we talked about in 'the basics', a lot of that does require some degree of manual setup.  So if every time you're creating a workload, you've got to make sure that the security policies are set up correctly, what happens if at one point someone fails to do that and something slips through code review - and then suddenly you have a workload that's exposed to the Internet?

And this is where I introduce you to the concept of 'Obscure Security', which is also known as 'the things you probably won't find in the basic user manual'.  Those of you who saw the FinOps talk that I gave in August last year would probably remember our little friend the hand-drawn bee, who is here to talk to you about buzzwords.  Because - IT as an industry is a very buzzword heavy industry, and like FinOps, security is also very buzzword-heavy.  And a lot of these obscure security concepts on Kubernetes are very very buzzword-heavy, in that, unless you've encountered them before, you're probably going to have no idea what I mean when I'm talking about things like service meshes.  But that's why you sort of have- these overviews to demystify some of those things, so - let's break some of this down and look at it in terms of the Obscure Security User Manual.

The first thing that we want to look at is general security tools that in some way integrate with our Kubernetes cluster.  And there are a couple of big ones here; the first one is application security testing, which breaks down to a whole lot of different things.  You may have heard of the concepts of SAST and DAST before if you've ever done anything with security - that's static and dynamic application security testing.  So effectively- nn, a lot of static application security testing boils down to code scanning.  Dynamic application security testing is more so black-box testing.

There's also - nn, as a bit of an extension of DAST, there's also automated tools for pen testing.  I'm not going to touch too much on those here, for the main reason that - a lot of them are not very easy to set up with Kubernetes out of the box, and there's probably better ways to do it, and that's not necessarily what an AppSec team will be dealing with anyway.  You would generally have dedicated pen testers - not AppSec, not DevSecOps, but you would generally have dedicated pen testers that would be using a lot of those.  But in terms of application security testing, that breaks down to - artifact scanning, which, for the purposes of containerised environments, is usually going to be images; code scanning, which is fairly self-explanatory; and infrastructure as code scanning, so, going away and looking at - basically your underlying workloads, the underlying, erm, infrastructure as code that you've set up for your cluster or whatever else you're running, and to see whether that is secure.

Part Two is tools that are specific to Kubernetes.  And that is really three different- or three main things.  The first one is cluster security scanning, so that's effectively tools that are going to go through and benchmark the state of your cluster against - best practices.  Then you've got things like runtime threat detection, which is trying to notify you before or at the same time as hackers are getting in.  And then there's service meshes - the aforementioned buzzword - which are really an abstraction layer on top of the Kubernetes cluster itself, that builds in a whole lot of stuff that is relevant to - security, but also site reliability-type work.  So it basically builds in a layer of observability, it builds in a layer of security, it abstracts away some of the things that you would generally have to do manually or go away and configure yourself, so it's kind of like a control plane on top of the already existing Kubernetes control plane.

So - you're interested in obscure security, and you want to actually deploy some of these things.  Well, there are a few different ways to do it: you can deploy things using `kubectl`, you can set up your own `helm` charts, but - generally what I would be looking at in terms of a lot of these tools, if you want to get things up and running quickly, is that a lot of them actually have pre-existing `helm` charts that are maintained for you, by either the people who maintain these open source projects, or by someone else who's taken it upon themselves to do that.  And the really good thing about that is you don't have to put in the effort of making sure that everything works out of the box.  Obviously, you will have to do some configuration that's specific to your own environment, which you can do using `helm` values files, but you are not going to need to set everything up - yourself, you can just often take what people have already produced and stick that on your cluster and you will be up and running.

So - I decided not to actually tempt the demo gods today, because I feel like demoing multiple tools would be just asking for something to go wrong.  I am - there is a, sort of, companion workshop that goes with this, I am going to publish all of the sources for this, and I'll be giving the workshop probably in a couple of months at AWS Programming and Tools - if you want to see how a lot of this breaks down, that workshop will appear on my GitHub page at some point.  One of the important things to note, though, particularly if you're working cross-provider, or if you're working on a bare metal- ah, Kubernetes setup, is - not every Kubernetes provider uses the same type of cluster management, and often those cluster management systems are very different.  So EKS has its own, Azure, Google Cloud, Alibaba Cloud all have their own, and if you're setting up a bare metal cluster, there are several different options that you can use for cluster management.  You can use `kops`, you can use Rancher, I'm sure that there are others out there.  The reason why this is important though, is because in terms of actually keeping the cluster up to date, that will be important.  But, in terms of why I decided not to tempt the demo gods, some of these tools are actually very finicky, and some of these tools, if you have things like version mismatches between your Kubernetes version and your cluster management version, you can run into some pretty big issues, particularly if you're running bare metal.  So do bear that in mind.

But otherwise, let's have a look at some of these tools.  For Docker image scanning - I'm going to look at, generally, open source tools that have `helm` charts where possible and the best option here is Clair.  The aim being that you would scan container images using player for common security vulnerabilities.  It uses a common repository of CVEs, but it does allow you to actually whitelist things if there are CVEs that you're not particularly concerned about, or if there are issues with your images but they're set up in a particular way - you know, you actually want certain things to be public facing, you can configure Clair to ignore those issues.  Clair does have a public helm chart which is maintained by Wiremind, so it is very much a one-click deployment and then you will have it up and running on your system.  And it's something where you can integrate it into your pipeline, so before you deploy an image or immediately after an image is built, you can run clear on it to make sure that there are no vulnerabilities there, and if it returns failures you can actually stop the pipeline.

Code scanning is probably one that just about everyone who's ever worked in an enterprise has actually heard of, and there are a million and one solutions for this that require you to fork over large amounts of money, but the open source option hands down is SonarQube.  Because not only does it perform code quality checks, it also scans your code for common application security issues, and it has the best language coverage of any options out there.  It does also have some third-party plug-ins for less common languages, erm, use at your own risk.  Don't ask how I know this, er, considering that I work at an organization now that uses a - a very niche language for very specific use cases, erm, but do tread at your own risk if you're using the third-party plugins.  And SonarQube also has a public `helm` chart which is maintained by Oteemo.  So again, it's a thing of - you can spin it up, you can enforce use of SonarQube in your pipelines, and you can just have the SonarQube instance quietly running on Kubernetes in the background.

And then there's infrastructure as code scanning, which is a bit of an interesting one because there are multiple options for this, including a couple that AWS suggests - and Snyk has a, paid option, but- in terms of open source options that you could install on your Kubernetes instance, Checkov is hands down the best for the simple reason that it doesn't just support Terraform, it also supports CloudFormation and basically all Kubernetes configuration files by default.  Now this one doesn't have a publicly maintained, sort of official supported `helm` chart.  There are some `helm` charts out there that people have set up themselves, but it will be a local install by default.  The other thing that you can do with it is for a lot of the pipelining tools, if you're running something like Jenkins on your Kubernetes instance, you can actually just whack it into Jenkins.  And so what Checkov will do is, again it's checking your infrastructure as code against baseline rules, it allows you some degree of customization, so you can actually go, you know, I want to make sure that we're not spinning up any of this type of resource, or I want to verify that these resources look the way that I would expect them to, and it's also looking for common security misconfigurations.  As part of that it does actually provide you with an overview of the way that all of your resources fit together, so you can then go back and look at that as well, and if you find that there are connections that you think shouldn't be there, it provides a very good starting point to actually go away and look at how the whole system is set up.

So that's it for- the tools that are not Kubernetes specific, but in terms of stuff that is Kubernetes specific, the first thing then to look at here is - cluster scanning.  So, `kube-bench` is the tool that I'm going to recommend for this - and Aqua Security, who produce `kube-bench`, have an absolutely fantastic suite of other Kubernetes tools, many of which I wish I could have managed to get into this talk, but `kube-bench` is one of the simplest tools that they - sort of have, and it does its job really well.  It will run a static check against your Kubernetes cluster, against the Centre for Internet Security's Kubernetes benchmarks, and it will give you back a report which is pass or fail.  You can run it against only specific sections of the benchmark, which is very useful, particularly if you're trying to remediate issues as you go.  Now, `kube-bench` can be installed on the Kubernetes host, there's no helm chart out of the box, but there are instructions on the GitHub repository, which will be in the sources which I'll finish reviewing and publishing later, there are instructions there for setting it up in a container that you can just deploy to Kubernetes.

Then we get into the fun things, the more buzzwordy things, and the first one of those is runtime security!  Probably the most common runtime security tool that people here would be familiar with is AWS GuardDuty, but the one that we're concerned with here, which is again, an open source tool, and this one is actually backed by the Cloud Native Computing Foundation - is Falco.  So, effectively what this does as a runtime security tool is a couple of things.  The first one is that you can actually tell it, 'I want only particular types of resources to be deployed to your clus- to my cluster, everything that goes on to my cluster I want to meet these particular security rules', and if, whatever you're deploying doesn't meet those security rules, then it will go and ping you on Slack, or PagerDuty, or OpsGenie, or VictorOps, or whatever sort of SRE tool you're using.  So you can then go and wake up the poor people who are monitoring your Kubernetes cluster and tell them to go and fix the deployment that someone else pushed at two o'clock in the morning.

The other really cool thing that Falco does, which is probably a bit more relevant to the type of work that GuardDuty does, is it will actually detect potential threats or potential malicious activity in real time.  So if someone is trying to crack the admin password to your cluster, or if there's, you know, a login from- somewhere in Europe, when your company is based in Australia, Falco will actually detect that and again, whichever poor sod is on the other end of the pager will get woken up to deal with it.  And the thing that's really good about Falco is it integrates with a lot of those common observability tools by default, so if you want to send Falco's observations to prometheus, or if you want to send Falco's observations directly to whatever you're using as a pager tool, you can do that really easily.  Obviously, with this one, there's some degree of configuration required to actually get it to work, but if you're looking for- something that's like GuardDuty for Kubernetes or that has some of the same features as GuardDuty for Kubernetes, this is where you'd want to go.

And then finally there's the service mesh, which is the truly buzzwordiest bit - of all of this obscure security.  Erm, and the one that's very common is Istio, it's the one that's been around for the longest, it's the one that's the most supported and the most in use.  And basically what service meshes do - eh, this is kind of a simplified description of it, but it's basically adding a layer of abstraction on top of the bare metal of your AWS cluster. So by default, it installs certain security tools for you, it installs certain observability tools for you, it will actually manage some of the interfaces between different Kubernetes services that you would usually need to manage yourself.  And so if you use it properly, which is a big if, service meshes can be great to reduce some of that misconfiguration.  One thing that's important to note, for people who regularly work across different types of clouds is, Google actually has an officially supported version of this, and they very specifically say 'don't install other service meshes, use the supported version', because they can't guarantee what will potentially go wrong With other service meshes.  So if you do happen to be running a GKE workload, I know this is an AWS meetup, but just be aware of that, because that is a huge gotcha if you want to install a service mesh.  And as with a lot of these tools, ah, Istio does actually maintain a public helm chart for this, so if you want to install it onto your cluster, it's really easy to do.

'But Dawn,' I hear you saying this time, 'there aren't enough hours in the day for all of our engineers to go away and install all of these tools!'  And I actually absolutely agree with you on that one, because there are a dizzying array of Kubernetes tools out there, and, as with everything else in IT, it's really about understanding what the right tool for the job is.  I do think, though, and, a lot of common security recommendations will back me up, that everyone should use, if you're running a Kubernetes workload - hell, if you're running any containerised workload - you should be using some sort of image scanner, because it's really easy for miss configurations to slip through a lot of those types of container images that you would use.  And everyone who's running a Kubernetes scanner, er, a Kubernetes cluster in my view, should be running a cluster scanner on a semi-regular basis to make sure that you're picking up any major misconfigurations that you have.  As far as a lot of the other tools, though, I think that most application security scanning tools have their place, but the real bang for your buck there is - large companies.  Because large companies with lots of devs, particularly if your security team is underfunded as they generally seem to be, it's going to be very difficult for you to be across all of the potential security vulnerabilities in a really big code base.  So if you can actually enforce every time you're running a CI pipeline that there have to be particular static application security tools running, you should absolutely do that.

I also think that there are a lot of good use cases particularly for the infrastructure as code scanning - if you are doing things like running Kubernetes clusters, if you've got the engineering time and the engineering capacity, it's probably also a good thing to have some sort of infrastructure as code scanning.  Because the thing you have to remember, particularly if you're not using CloudFormation, is - there are some different attack vectors that, if you've been very locked into the AWS ecosystem, you might not be used to, and a lot of those infrastructure as code scanning tools will actually surface that for you.

The runtime security tools, things like Falco, are great, but in my view they're a nice to have.  I think it's fantastic to be able to get all of that stuff automated into one place, but at the same time, there are potentially a lot of other things that you can do with your time that are going to be much more impactful.  So if you have the time to set it up properly, great, absolutely go and do it, but make sure that you've got all of the basics nailed down first.  The service meshes however, in my view, are quite situational.  They give you a lot of really good resources, but they add a layer of complexity on top of the default, sort of - container management and control plane of Kubernetes, so - they're probably better suited for if you have very complex workloads or very sprawling workloads running on Kubernetes, ah, definitely research that before you commit your time and resources to it.

There are also, out on the internet, a lot of other obscure security sources.  Erm, I did reference when I was talking about `kube-bench` the entire suite of acr- Aqua Security products.  They have a lot of really really good stuff there that, at some point I want to just spend a weekend installing it all on a cluster and seeing what it does, but if you have a Kubernetes security related problem, they've probably got a tool that at least partially solves it.  The other thing that's really cool about Kubernetes and `helm` charts is, like there are public repositories for Docker images, there are actually public repositories for workloads that are commonly run on Kubernetes, in particular Artifact Hub.  And, when I was initially looking at security of Kubernetes clusters, a lot of these tools I actually found by just going to ArtifactHub, scrolling through the security section, researching things, and then discarding anything that wasn't useful and going more deeply into the things that looked useful for me.

So I will now be taking questions. As per usual, erm, the folks at AWS and I are still talking to each other about a lot of these meetups, ahm, I've become part of the AWS Developer Acceleration program.  So if you do want to get in contact with AWS about things like Kubernetes, about the things that I've been discussing in this talk, then please feel free to use the QR code on the slides.  There is also some speaker feedback there, so if you would fill that in, that will come back to me, and that is always really helpful for me in deciding what to do next.

ARJEN: Cool, thanks Dawn.  That was a very interesting presentation again as usual.

DAWN: [laughter]

ARJEN: So, that's not surprising!  Erm, now, so far, we've had a single question, so this is also a reminder to everybody, ask your questions now while Dawn can answer them, because when she [sic] is not on screen anymore, it becomes harder to do so.  But let's start with the first question from Prakash: 'Are there container images available that are secured by default?'

DAWN: Ah, i- as with all of these things, it depends on exactly what you want to do with them.  A lot of container images that companies will produce for their default workloads will be secured by default.  The use case for tools like Clair is more so if you're building your own workloads and deploying them to Kubernetes, or to some other container orchestration application, you want to have something that's doing that scanning for you.  You can also sometimes end up in really interesting situations where - companies produce, you know, images that you would think would be secure, and then you run them against a tool like Clair, and you discover that they're not quite as secure as you thought they might have been.  So it's going to be very situational, it very much depends on exactly what you're trying to do - as to whether the images that you would be using will be secure by default.  Having said that, though, if your main interest is in, you know, 'how can I secure container images?', a lot of those benchmarks that a lot of the tools, not just Clair but SonarQube and other code scanning tools as well use, are published.  So if you dig hard enough, you can- you can actually go to them and you can find the underlying set of rules that they're using, which will allow you to do a sanity check on anything that you're producing before it finds its way, you know, either to Clair or onto your clusters or whatever else you're using for container orchestration.

ARJEN: Oh, that makes sense.  I see - another question, ah has come in from Katherine, ah, it's not the hardest one, but will the slide deck be available?

DAWN: Ah...

ARJEN: Because she would love to have a list of the tools so she can try them out.

DAWN: So, the way that I usually do these sorts of things, and usually I would do it in advance, but, ah, time was not kind to me this past week - if you go to my GitHub page, erm, I have a whole repository for all of the talks that I've done, and I publish links, and I will also publish all of the sources that I've used.  So when that is online, I will make sure that it also appears on the Slack, and that will have links - because all of those tools that I've mentioned there are open source - so it will have links to the actual repositories, and for the tools that have `helm` charts, it will also have links to the `helm` charts.

ARJEN: Cool, that's always good.  Erm, it might be useful if, after you're done, you post a link to your GitHub in the chat as well.

DAWN: Yeah, I will do that.

ARJEN: Great.  Erm, I don't see any other questions coming up. 

DAWN: I think I did vaguely see one when I looked about AWS Secrets Manager, and the answer to that, erm, Secrets Manager and HashiCorp Vault are interchangeable for some things, but a lot of the default Kubernetes workloads that you would use would be more so things that would use KMS, hence why, KMS is - things like mutual TLS, which is a lot of what's mentioned in the basics, that will tend to be stuff that's backed more by KMS than, erm, Secrets Manager, but Secrets Manager is really good for if you want to take secrets and integrate them into your workload, rather than just have somewhere to store encryption keys and certificates that you're using for mutual TLS.

ARJEN: Cool, makes sense.  Ah, I think that's it then.  Nobody else has jumped up with a question, so I'm assuming that means everybody is now all up to date on obscure Kubernetes security.  So Dawn, thank you again. 

DAWN: Thank you for having me.

ARJEN: Yep.  It's always a pleasure.
